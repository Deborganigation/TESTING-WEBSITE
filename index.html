<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcureHub - Final Version</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
            --info-color: #0dcaf0; --warning-color: #ffc107; --danger-color: #dc3545;
            --sidebar-bg: #212529; --sidebar-text: #adb5bd; --sidebar-hover: #343a40;
            --content-bg: #f8f9fa;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Login Page Styles --- */
        #login-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        #login-video-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1;
            filter: brightness(0.4);
        }
        #login-container {
            width: 100%; max-width: 420px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
        }

        /* --- Main App Layout Styles --- */
        .main-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: var(--sidebar-text); padding: 20px; display: flex; flex-direction: column; }
        .sidebar .logo { font-size: 1.6rem; font-weight: 700; text-align: center; color: white; padding-bottom: 20px; border-bottom: 1px solid var(--sidebar-hover); margin-bottom: 20px; }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.3s ease; white-space: nowrap; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: var(--primary-color); color: white; }
        .sidebar .nav-link i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid var(--sidebar-hover); padding-top: 15px; text-align: center; }
        .main-content { flex-grow: 1; padding: 25px; overflow-x: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .stat-card { border: none; border-radius: 12px; color: white; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); transition: transform 0.2s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .display-4 { font-weight: 700; }
        .stat-card i.stat-icon { font-size: 3.5rem; opacity: 0.2; }
        .nav-tabs .nav-link.active { background-color: var(--primary-color); color: white; }
        .table-hover tbody tr:hover { cursor: pointer; background-color: #e9ecef; }
    </style>
</head>
<body>

    <div id="login-wrapper" class="login-wrapper">
        <video autoplay muted loop id="login-video-bg">
            <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div id="login-container" class="card p-4 shadow-lg border-0">
            <h2 class="text-center mb-1"><i class="fas fa-tasks text-primary"></i> ProcureHub</h2>
            <p class="text-center text-muted mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3"><input type="password" id="password" class="form-control" placeholder="Password" required></div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
            <p id="login-error" class="text-danger mt-3 text-center mb-0"></p>
        </div>
    </div>

    <div id="app-container" class="main-container hidden">
        <nav class="sidebar">
            <div class="logo"><i class="fas fa-tasks"></i> ProcureHub</div>
            <div id="nav-links">
                <a class="nav-link admin-nav-item" data-view="admin-dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link admin-nav-item" data-view="admin-requirements-view"><i class="fas fa-file-alt"></i> All Requirements</a>
                <a class="nav-link admin-nav-item" data-view="admin-awarded-view"><i class="fas fa-trophy"></i> Awarded Contracts</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-reqs-view"><i class="fas fa-inbox"></i> Requisition Approvals</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-users-view"><i class="fas fa-user-check"></i> User Approvals</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-dashboard-view"><i class="fas fa-clipboard-list"></i> My Requirements</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-awarded-view"><i class="fas fa-trophy"></i> My Awarded Contracts</a>
                <a class="nav-link user-nav-item" data-view="user-dashboard-view"><i class="fas fa-edit"></i> Create Requisition</a>
            </div>
            <div class="user-profile">
                <h6 id="user-name-sidebar"></h6>
                <small id="user-email-sidebar" class="text-muted"></small>
                <button onclick="handleLogout()" class="btn btn-sm btn-outline-light w-100 mt-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="top-header"><h1 id="header-title" class="h4 mb-0"></h1></div>
            <div id="main-view">
                
                <div id="admin-dashboard-view" class="view hidden">
                    <div class="row g-4 mb-4">
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-primary" onclick="navigateTo('admin-requirements-view')"><div><h5 class="mb-0">Active Tenders</h5><p class="display-4" id="stats-active-tenders">--</p></div><i class="fas fa-file-alt stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-success" onclick="navigateTo('admin-pending-users-view')"><div><h5 class="mb-0">Registered Vendors</h5><p class="display-4" id="stats-registered-vendors">--</p></div><i class="fas fa-users stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-warning"><div><h5 class="mb-0">Pending Bids</h5><p class="display-4" id="stats-pending-bids">--</p></div><i class="fas fa-hourglass-half stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-info" onclick="navigateTo('admin-awarded-view')"><div><h5 class="mb-0">Contracts Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                    <div class="card shadow-sm border-0"><div class="card-body"><canvas id="adminChart"></canvas></div></div>
                </div>

                <div id="admin-requirements-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">All Requirements</h5><button class="btn btn-sm btn-outline-primary" onclick="downloadCSV('Requirements')"><i class="fas fa-download me-2"></i>Download CSV</button></div>
                        <div class="card-body">
                            <div class="mb-3 p-3 bg-light border rounded"><h6><i class="fas fa-upload me-2"></i>Bulk Upload</h6><input type="file" id="bulkUploadInput" class="form-control form-control-sm" accept=".csv, .xlsx"><div id="upload-status" class="mt-2 small"></div></div>
                            <div id="admin-req-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table table-hover align-middle" id="admin-req-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Image</th><th>Status</th><th>Deadline</th></tr></thead><tbody id="admin-req-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
                
                <div id="admin-awarded-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Awarded Contracts</h5><button class="btn btn-sm btn-outline-primary" onclick="downloadCSV('AwardedContracts')"><i class="fas fa-download me-2"></i>Download CSV</button></div>
                        <div class="card-body">
                            <div id="admin-awarded-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-awarded-table" style="display:none;"><thead class="table-light"><tr><th>Contract ID</th><th>Product</th><th>Vendor</th><th>Amount (₹)</th><th>Awarded Date</th></tr></thead><tbody id="admin-awarded-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div id="admin-pending-reqs-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending Requisition Approvals</h5></div>
                        <div class="card-body">
                            <div id="admin-pending-reqs-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-pending-reqs-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Created By</th><th>Date</th><th>Action</th></tr></thead><tbody id="admin-pending-reqs-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div id="admin-pending-users-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending User Approvals</h5></div>
                        <div class="card-body">
                            <div id="admin-pending-users-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-pending-users-table" style="display:none;"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div id="vendor-dashboard-view" class="view hidden">
                     <div class="row g-4 mb-4">
                        <div class="col-md-4"><div class="stat-card bg-info"><div><h5 class="mb-0">Assigned Tenders</h5><p class="display-4" id="vendor-stats-assigned">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-secondary"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="vendor-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-success" onclick="navigateTo('vendor-awarded-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="vendor-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                     <div class="card shadow-sm border-0">
                         <div class="card-header bg-white"><h5 class="mb-0">My Assigned Requirements</h5></div>
                         <div class="card-body">
                            <div class="p-3 bg-light border rounded mb-3"><h6><i class="fas fa-download me-2"></i>Download Bidding History</h6><div class="row g-2 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Start Date</label><input type="date" id="startDate" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">End Date</label><input type="date" id="endDate" class="form-control form-control-sm"></div><div class="col-md-4"><button id="download-history-btn" class="btn btn-sm btn-success w-100">Download CSV</button></div></div></div>
                            <div id="vendor-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table table-hover align-middle" id="vendor-req-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Image</th><th>Deadline</th><th>My Bid Status</th><th>My Rank</th></tr></thead><tbody id="vendor-req-tbody"></tbody></table></div>
                         </div>
                     </div>
                </div>
                
                <div id="vendor-awarded-view" class="view hidden">
                     <div class="card shadow-sm border-0">
                         <div class="card-header bg-white"><h5 class="mb-0">My Awarded Contracts</h5></div>
                         <div class="card-body">
                            <div id="vendor-awarded-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="vendor-awarded-table" style="display:none;"><thead class="table-light"><tr><th>Contract ID</th><th>Product</th><th>Amount (₹)</th><th>Awarded Date</th></tr></thead><tbody id="vendor-awarded-tbody"></tbody></table></div>
                         </div>
                     </div>
                </div>
                
                <div id="user-dashboard-view" class="view hidden">
                    <div class="row g-4">
                        <div class="col-md-7">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-edit me-2"></i>Create a New Requisition</h5></div>
                                <div class="card-body"><form id="requisition-form"><div class="row"><div class="col-md-6 mb-3"><label for="req-product-name" class="form-label">Product Name</label><input type="text" id="req-product-name" class="form-control" required></div><div class="col-md-6 mb-3"><label for="req-quantity" class="form-label">Quantity</label><input type="number" id="req-quantity" class="form-control" required></div></div><div class="mb-3"><label for="req-description" class="form-label">Description</label><textarea id="req-description" class="form-control" rows="3"></textarea></div><div class="mb-3"><label for="req-image" class="form-label">Reference Image (Optional)</label><input type="file" id="req-image" class="form-control" accept="image/*"></div><h6 class="mt-4">Select Vendors to Notify</h6><div id="req-vendor-checklist" class="mb-3 border rounded p-3" style="max-height: 150px; overflow-y: auto;"><p class="text-muted">Loading vendors...</p></div><button type="submit" class="btn btn-primary w-100 fw-bold">Submit for Approval</button></form></div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Requisition Status</h5></div>
                                <div id="user-req-status-loader" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>
                                <div id="user-req-status-list" class="list-group list-group-flush"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-company" class="form-control" placeholder="Company Name (for Vendors)"></div><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Vendor">Vendor</option><option value="User">User</option></select></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bidModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="bidModalTitle">Place Bid</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="bid-form"><input type="hidden" id="bid-req-id"><div class="mb-3"><label for="bidAmount" class="form-label">Bid Amount (₹)</label><input type="number" class="form-control" id="bidAmount" required></div><div class="mb-3"><label for="bidComments" class="form-label">Comments</label><textarea class="form-control" id="bidComments" rows="3"></textarea></div><button type="submit" class="btn btn-primary w-100">Submit Bid</button></form></div></div></div></div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="adminActionModalTitle">Requirement Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-tabs" id="admin-modal-tabs"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#view-bids-pane">View Bids</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#assign-vendors-pane">Assign Vendors</button></li></ul><div class="tab-content"><div class="tab-pane fade show active p-3" id="view-bids-pane"><div id="bids-loader" class="text-center p-4"><div class="spinner-border text-success"></div></div><div class="table-responsive"><table class="table table-striped" id="bids-table" style="display:none;"><thead><tr><th>Rank</th><th>Vendor</th><th>Amount (₹)</th><th>Comments</th><th>Status</th><th>Action</th></tr></thead><tbody id="bids-tbody"></tbody></table></div></div><div class="tab-pane fade p-3" id="assign-vendors-pane"><div id="vendors-loader" class="text-center p-4"><div class="spinner-border text-info"></div></div><div id="vendor-list"></div><button class="btn btn-primary mt-3" id="save-assignments-btn">Save Assignments</button></div></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxqNOQWhMSQJjlWmimq5jYvjwZqMmBvhHcahq4x6vfHS5lbcal_awN4KiQzpD4k4C0/exec'; 

        // --- GLOBAL CACHE & DOM REFERENCES ---
        let APP_DATA = {};
        const loginWrapper = document.getElementById('login-wrapper'), appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error');
        const mainView = document.getElementById('main-view'), headerTitle = document.getElementById('header-title');
        const navLinksContainer = document.getElementById('nav-links');
        let registerModal, bidModal, adminActionModal, adminChart;

        // --- CORE APP LOGIC ---
        window.onload = () => {
            registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
            bidModal = new bootstrap.Modal(document.getElementById('bidModal'));
            adminActionModal = new bootstrap.Modal(document.getElementById('adminActionModal'));
            if (sessionStorage.getItem('loggedInUser')) {
                const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
                setupUIForRole(user);
                loadInitialData().then(success => {
                    if(success) {
                        const defaultViews = { 'Admin': 'admin-dashboard-view', 'Vendor': 'vendor-dashboard-view', 'User': 'user-dashboard-view' };
                        navigateTo(defaultViews[user.Role]);
                    } else { alert("Could not refresh data from server."); }
                });
            }
        };

        // --- OPTIMIZED DATA FETCHING ---
        async function loadInitialData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Server responded with an error");
                const result = await response.json();
                if (result.success) { APP_DATA = result.data; return true; }
                loginError.textContent = result.error; return false;
            } catch (error) {
                console.error("Failed to load initial data:", error);
                loginError.textContent = "Could not connect to server. Check API URL and script deployment.";
                return false;
            }
        }
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = 'Loading data...';
            const success = await loadInitialData();
            if (success) {
                loginError.textContent = 'Authenticating...';
                const users = APP_DATA.users;
                const foundUser = users.find(user => user.Email === document.getElementById('email').value && user.Password === document.getElementById('password').value);
                if (foundUser) {
                    sessionStorage.setItem('loggedInUser', JSON.stringify(foundUser));
                    setupUIForRole(foundUser);
                } else { loginError.textContent = 'Invalid email or password.'; }
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const result = await postData({ action: 'submitRegistration', data: { FullName: document.getElementById('reg-fullname').value, Email: document.getElementById('reg-email').value, Password: document.getElementById('reg-password').value, CompanyName: document.getElementById('reg-company').value, Role: document.getElementById('reg-role').value } });
            if (result.success) { alert(result.message); registerModal.hide(); } 
            else { alert('Registration failed: ' + result.error); }
        });

        function handleLogout() {
            sessionStorage.removeItem('loggedInUser');
            window.location.reload();
        }

        // --- NAVIGATION & UI SETUP ---
        function navigateTo(viewId) {
            const navLinkElement = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            mainView.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');

            navLinksContainer.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            if (navLinkElement) {
                 navLinkElement.classList.add('active');
                 headerTitle.textContent = navLinkElement.textContent.trim();
            }
            
            const viewLoadFunctions = {
                'admin-dashboard-view': loadAdminDashboard, 'admin-requirements-view': loadAdminRequirements,
                'admin-awarded-view': loadAdminAwardedContracts, 'admin-pending-reqs-view': loadPendingRequisitions,
                'admin-pending-users-view': loadPendingUsers, 'vendor-dashboard-view': () => loadVendorDashboard(JSON.parse(sessionStorage.getItem('loggedInUser')).UserID),
                'vendor-awarded-view': () => loadVendorAwarded(JSON.parse(sessionStorage.getItem('loggedInUser')).UserID),
                'user-dashboard-view': loadUserDashboard,
            };
            viewLoadFunctions[viewId]?.();
        }
        
        function setupUIForRole(user) {
            loginWrapper.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('user-name-sidebar').textContent = user.FullName;
            document.getElementById('user-email-sidebar').textContent = user.Email;
            document.querySelectorAll('#nav-links .nav-link').forEach(link => link.classList.add('hidden'));
            document.querySelectorAll(`.${user.Role.toLowerCase()}-nav-item`).forEach(link => link.classList.remove('hidden'));
            const defaultViews = { 'Admin': 'admin-dashboard-view', 'Vendor': 'vendor-dashboard-view', 'User': 'user-dashboard-view' };
            navigateTo(defaultViews[user.Role]);
        }

        // --- ADMIN FUNCTIONS ---
        function loadAdminDashboard() {
            const reqs = APP_DATA.requirements || []; const users = APP_DATA.users || []; 
            const bids = APP_DATA.bids || []; const awarded = APP_DATA.awarded || [];
            document.getElementById('stats-active-tenders').textContent = reqs.filter(r => r.Status === 'Active').length;
            document.getElementById('stats-registered-vendors').textContent = users.filter(u => u.Role === 'Vendor').length;
            document.getElementById('stats-pending-bids').textContent = bids.filter(b => b.BidStatus === 'Submitted').length;
            document.getElementById('stats-awarded-contracts').textContent = awarded.length;
            
            const ctx = document.getElementById('adminChart').getContext('2d');
            const bidsPerReq = bids.reduce((acc, bid) => { acc[bid.RequirementID] = (acc[bid.RequirementID] || 0) + 1; return acc; }, {});
            if (adminChart) adminChart.destroy();
            adminChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(bidsPerReq), datasets: [{ label: '# of Bids per Requirement', data: Object.values(bidsPerReq), backgroundColor: 'rgba(74, 144, 226, 0.7)', borderColor: 'rgba(74, 144, 226, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        
        function loadAdminRequirements() {
            const loader = document.getElementById('admin-req-loader'), table = document.getElementById('admin-req-table'), tbody = document.getElementById('admin-req-tbody');
            loader.style.display = 'block'; table.style.display = 'none';
            const reqs = APP_DATA.requirements || [];
            const nonAwardedReqs = reqs.filter(r => r.Status !== 'Awarded');
            tbody.innerHTML = '';
            nonAwardedReqs.forEach(req => {
                const row = document.createElement('tr');
                const imageUrlCell = req.ImageURL ? `<a href="${req.ImageURL}" target="_blank"><i class="fas fa-image"></i></a>` : '-';
                row.innerHTML = `<td>${req.RequirementID}</td><td>${req.ProductName}</td><td>${imageUrlCell}</td><td><span class="badge bg-${getBadgeColor(req.Status)}">${req.Status}</span></td><td>${new Date(req.Deadline).toLocaleDateString()}</td>`;
                row.onclick = () => openAdminActionModal(req.RequirementID);
                tbody.appendChild(row);
            });
            table.style.display = 'table'; loader.style.display = 'none';
        }
        
        function loadAdminAwardedContracts() {
            const loader = document.getElementById('admin-awarded-loader'), table = document.getElementById('admin-awarded-table'), tbody = document.getElementById('admin-awarded-tbody');
            loader.style.display = 'block'; table.style.display = 'none';
            const awarded = APP_DATA.awarded || [];
            tbody.innerHTML = awarded.length > 0 ? '' : '<tr><td colspan="5" class="text-center">No contracts awarded yet.</td></tr>';
            awarded.forEach(c => { tbody.innerHTML += `<tr><td>${c.ContractID}</td><td>${c.ProductName}</td><td>${c.VendorName}</td><td>₹${c.AwardedAmount}</td><td>${new Date(c.AwardedDate).toLocaleDateString()}</td></tr>`; });
            table.style.display = 'table'; loader.style.display = 'none';
        }

        function loadPendingRequisitions() {
            const loader = document.getElementById('admin-pending-reqs-loader'), table = document.getElementById('admin-pending-reqs-table'), tbody = document.getElementById('admin-pending-reqs-tbody');
            loader.style.display = 'block'; table.style.display = 'none';
            const reqs = APP_DATA.requirements || []; const users = APP_DATA.users || [];
            const pendingReqs = reqs.filter(r => r.Status === 'Pending Approval');
            tbody.innerHTML = pendingReqs.length > 0 ? '' : '<tr><td colspan="5" class="text-center">No pending requisitions.</td></tr>';
            pendingReqs.forEach(req => {
                const creatorName = users.find(u => u.UserID === req.CreatedBy)?.FullName || 'N/A';
                tbody.innerHTML += `<tr><td>${req.RequirementID}</td><td>${req.ProductName}</td><td>${creatorName}</td><td>${new Date(req.CreatedAt).toLocaleDateString()}</td><td><button class="btn btn-sm btn-success" onclick="approveRequisition('${req.RequirementID}')">Approve</button></td></tr>`;
            });
            table.style.display = 'table'; loader.style.display = 'none';
        }
        
        async function approveRequisition(reqId) {
            const result = await postData({ action: 'updateRecord', data: { sheetName: 'Requirements', id: reqId, record: { Status: 'Active' } } });
            if(result.success) { alert('Requisition Approved!'); loadInitialData().then(() => loadPendingRequisitions()); } else { alert('Error!'); }
        }

        function loadPendingUsers() {
            const loader = document.getElementById('admin-pending-users-loader'), table = document.getElementById('admin-pending-users-table'), tbody = document.getElementById('admin-pending-users-tbody');
            loader.style.display = 'block'; table.style.display = 'none';
            const pendingUsers = APP_DATA.pendingUsers || [];
            tbody.innerHTML = pendingUsers.length > 0 ? '' : '<tr><td colspan="5" class="text-center">No pending approvals.</td></tr>';
            pendingUsers.forEach(user => { tbody.innerHTML += `<tr><td>${user.FullName}</td><td>${user.Email}</td><td>${user.Role}</td><td>${user.CompanyName}</td><td><button class="btn btn-sm btn-success" onclick="approveUser('${user.TempID}')">Approve</button></td></tr>`; });
            table.style.display = 'table'; loader.style.display = 'none';
        }
        
        async function approveUser(tempId) {
            const result = await postData({ action: 'approveUser', data: { TempID: tempId } });
            if (result.success) { alert(result.message); loadInitialData().then(() => loadPendingUsers()); } else { alert('Approval failed: ' + result.error); }
        }

        document.getElementById('bulkUploadInput').addEventListener('change', async (event) => {
            const file = event.target.files[0]; if (!file) return;
            const statusDiv = document.getElementById('upload-status'); statusDiv.innerHTML = `<div class="spinner-border spinner-border-sm"></div> Reading file...`;
            const data = await file.arrayBuffer(); let requirements = [];
            if (file.name.endsWith('.csv')) { requirements = Papa.parse(new TextDecoder("utf-8").decode(data), { header: true, skipEmptyLines: true }).data; }
            else { const workbook = XLSX.read(data, { type: 'array' }); requirements = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); }
            if (requirements.length > 0) {
                statusDiv.innerHTML = `<div class="spinner-border spinner-border-sm"></div> Uploading ${requirements.length} records...`;
                const result = await postData({ action: 'bulkUploadRequirements', data: requirements });
                statusDiv.innerHTML = result.success ? `<span class="text-success">${result.message}</span>` : `<span class="text-danger">Error: ${result.error}</span>`;
                if(result.success) loadInitialData().then(() => loadAdminRequirements());
            }
        });

        async function openAdminActionModal(reqId) {
            adminActionModal.show();
            document.getElementById('adminActionModalTitle').textContent = `Details for ${reqId}`;
            document.getElementById('adminActionModal').dataset.reqId = reqId;
            document.getElementById('view-bids-tab').click();
            loadBidsForAdmin(reqId);
            loadVendorsForAssignment(reqId);
        }

        function loadBidsForAdmin(reqId) {
            const bidsTbody = document.getElementById('bids-tbody');
            document.getElementById('bids-loader').style.display = 'block'; document.getElementById('bids-table').style.display = 'none'; bidsTbody.innerHTML = '';
            const allBids = APP_DATA.bids || [];
            const relevantBids = allBids.filter(bid => bid.RequirementID === reqId).sort((a, b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount));
            if(relevantBids.length > 0) {
                 relevantBids.forEach((bid, index) => {
                    const rank = `L${index + 1}`;
                    const vendorName = (APP_DATA.users || []).find(u => u.UserID === bid.VendorID)?.FullName || bid.VendorID;
                    const statusOptions = ['Submitted', 'Viewed', 'Accepted', 'Rejected'].map(s => `<option value="${s}" ${s === bid.BidStatus ? 'selected' : ''}>${s}</option>`).join('');
                    bidsTbody.innerHTML += `<tr><td><span class="badge bg-info">${rank}</span></td><td>${vendorName}</td><td>₹${bid.BidAmount}</td><td>${bid.Comments}</td><td><select class="form-select form-select-sm" onchange="updateBidStatus('${bid.BidID}', this.value)">${statusOptions}</select></td><td><button class="btn btn-sm btn-success" onclick='awardContract(${JSON.stringify(bid)})'>Award</button></td></tr>`;
                });
            } else { bidsTbody.innerHTML = '<tr><td colspan="6" class="text-center">No bids submitted yet.</td></tr>'; }
            document.getElementById('bids-loader').style.display = 'none'; document.getElementById('bids-table').style.display = 'table';
        }

        async function updateBidStatus(bidId, newStatus) { 
            await postData({ action: 'updateRecord', data: { sheetName: 'Bids', id: bidId, record: { BidStatus: newStatus } } });
            // No alert needed for simple status change, for better UX
        }

        async function awardContract(bid) {
            if (!confirm(`Are you sure you want to award this contract to Vendor for ₹${bid.BidAmount}?`)) return;
            const requirement = (APP_DATA.requirements || []).find(r => r.RequirementID === bid.RequirementID);
            const vendor = (APP_DATA.users || []).find(u => u.UserID === bid.VendorID);
            const result = await postData({ action: 'awardContract', data: { bid: bid, productName: requirement.ProductName, vendorName: vendor.FullName } });
            if(result.success) {
                alert('Contract awarded successfully!');
                adminActionModal.hide();
                loadInitialData().then(() => loadAdminRequirements());
            } else { alert('Error awarding contract.'); }
        }

        function loadVendorsForAssignment(reqId) {
            const vendorListDiv = document.getElementById('vendor-list');
            document.getElementById('vendors-loader').style.display = 'block'; vendorListDiv.innerHTML = '';
            const assignments = APP_DATA.assignments || []; const users = APP_DATA.users || [];
            const vendors = users.filter(u => u.Role === 'Vendor');
            const assignedVendorIds = assignments.filter(a => a.RequirementID === reqId).map(a => a.VendorID);
            vendorListDiv.innerHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${v.UserID}" id="v-${v.UserID}" ${assignedVendorIds.includes(v.UserID) ? 'checked' : ''}><label class="form-check-label" for="v-${v.UserID}">${v.FullName}</label></div>`).join('');
            document.getElementById('vendors-loader').style.display = 'none';
        }
        
        document.getElementById('save-assignments-btn').addEventListener('click', async () => {
            const reqId = document.getElementById('adminActionModal').dataset.reqId;
            const selectedVendorIds = Array.from(document.querySelectorAll('#vendor-list input:checked')).map(input => input.value);
            const result = await postData({ action: 'assignVendors', data: { RequirementID: reqId, vendorIds: selectedVendorIds } });
            if (result.success) { alert('Assignments saved!'); adminActionModal.hide(); } else { alert('Error saving assignments.'); }
        });

        // --- VENDOR FUNCTIONS ---
        function loadVendorDashboard(vendorId) {
             const loader = document.getElementById('vendor-loader'), table = document.getElementById('vendor-req-table'), tbody = document.getElementById('vendor-req-tbody');
             loader.style.display = 'block'; table.style.display = 'none';
             const allReqs = APP_DATA.requirements || []; const allAssignments = APP_DATA.assignments || []; const allBids = APP_DATA.bids || [];
            
            const myBids = allBids.filter(b => b.VendorID === vendorId);
            const assignedReqIds = allAssignments.filter(a => a.VendorID === vendorId).map(a => a.RequirementID);
            const assignedReqs = allReqs.filter(r => assignedReqIds.includes(r.RequirementID) && r.Status === 'Active');
            
            document.getElementById('vendor-stats-assigned').textContent = assignedReqs.length;
            document.getElementById('vendor-stats-submitted').textContent = myBids.length;
            document.getElementById('vendor-stats-won').textContent = myBids.filter(b => b.BidStatus === 'Awarded').length;

            tbody.innerHTML = '';
            assignedReqs.forEach(req => {
                const myBidsForThisReq = myBids.filter(b => b.RequirementID === req.RequirementID);
                const allBidsForThisReq = allBids.filter(b => b.RequirementID === req.RequirementID).sort((a,b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount));
                const myLatestBid = myBidsForThisReq.sort((a, b) => new Date(b.SubmittedAt) - new Date(a.SubmittedAt))[0];
                const myRankIndex = myLatestBid ? allBidsForThisReq.findIndex(b => b.BidID === myLatestBid.BidID) : -1;
                const myRank = myRankIndex !== -1 ? `L${myRankIndex + 1}` : '-';
                const bidStatus = myLatestBid ? `<span class="badge bg-${getBadgeColor(myLatestBid.BidStatus)}">${myLatestBid.BidStatus}</span>` : 'Not Submitted';
                const imageUrlCell = req.ImageURL ? `<a href="${req.ImageURL}" target="_blank"><i class="fas fa-image"></i></a>` : '-';
                const row = document.createElement('tr');
                row.innerHTML = `<td>${req.RequirementID}</td><td>${req.ProductName}</td><td>${imageUrlCell}</td><td>${new Date(req.Deadline).toLocaleDateString()}</td><td>${bidStatus}</td><td>${myRank}</td>`;
                row.onclick = () => openBidModal(req);
                tbody.appendChild(row);
            });
            table.style.display = 'table'; loader.style.display = 'none';
        }
        
        function loadVendorAwarded(vendorId) {
            const loader = document.getElementById('vendor-awarded-loader'), table = document.getElementById('vendor-awarded-table'), tbody = document.getElementById('vendor-awarded-tbody');
            loader.style.display = 'block'; table.style.display = 'none';
            const awarded = (APP_DATA.awarded || []).filter(c => c.VendorID === vendorId);
            tbody.innerHTML = awarded.length > 0 ? '' : '<tr><td colspan="4" class="text-center">No contracts awarded to you yet.</td></tr>';
            awarded.forEach(c => { tbody.innerHTML += `<tr><td>${c.ContractID}</td><td>${c.ProductName}</td><td>₹${c.AwardedAmount}</td><td>${new Date(c.AwardedDate).toLocaleDateString()}</td></tr>`; });
            table.style.display = 'table'; loader.style.display = 'none';
        }

        function openBidModal(req) {
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            document.getElementById('bidModalTitle').textContent = `Bid for: ${req.ProductName}`;
            document.getElementById('bid-req-id').value = req.RequirementID;
            const form = document.getElementById('bid-form'); form.reset();
            const myBidsForThisReq = (APP_DATA.bids || []).filter(b => b.RequirementID === req.RequirementID && b.VendorID === currentUser.UserID);
            const submitButton = form.querySelector('button[type="submit"]');
            if (myBidsForThisReq.length >= 3) {
                submitButton.disabled = true; submitButton.textContent = 'Maximum 3 Bids Reached';
                form.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
            } else {
                submitButton.disabled = false; submitButton.textContent = 'Submit Bid';
                form.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
            }
            bidModal.show();
        }

        document.getElementById('bid-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const result = await postData({ action: 'createBid', data: { RequirementID: document.getElementById('bid-req-id').value, VendorID: user.UserID, BidAmount: document.getElementById('bidAmount').value, Comments: document.getElementById('bidComments').value, BidStatus: 'Submitted' } });
            if (result.success) { alert('Bid submitted!'); bidModal.hide(); loadInitialData().then(() => loadVendorDashboard(user.UserID)); } 
            else { alert('Error: ' + result.error); }
        });
        
        document.getElementById('download-history-btn').addEventListener('click', () => {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value;
            let downloadUrl = `${API_URL}?format=csv&vendorId=${user.UserID}`;
            if (startDate) downloadUrl += `&startDate=${startDate}`; if (endDate) downloadUrl += `&endDate=${endDate}`;
            window.open(downloadUrl, '_blank');
        });

        // --- USER FUNCTIONS ---
        function loadUserDashboard() {
            const checklistDiv = document.getElementById('req-vendor-checklist');
            const vendors = (APP_DATA.users || []).filter(u => u.Role === 'Vendor');
            if (vendors.length > 0) {
                const selectAllHTML = `<div class="form-check fw-bold border-bottom pb-2 mb-2"><input class="form-check-input" type="checkbox" id="vendor-select-all"><label class="form-check-label" for="vendor-select-all">Select All Vendors</label></div>`;
                const vendorListHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input vendor-checkbox" type="checkbox" value="${v.UserID}" id="vendor-${v.UserID}"><label class="form-check-label" for="vendor-${v.UserID}">${v.FullName}</label></div>`).join('');
                checklistDiv.innerHTML = selectAllHTML + vendorListHTML;
                document.getElementById('vendor-select-all').addEventListener('change', (e) => { document.querySelectorAll('.vendor-checkbox').forEach(checkbox => checkbox.checked = e.target.checked); });
            } else { checklistDiv.innerHTML = '<p class="text-danger">No registered vendors found.</p>'; }
            loadUserRequisitionStatus();
        }

        function loadUserRequisitionStatus() {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const listDiv = document.getElementById('user-req-status-list');
            document.getElementById('user-req-status-loader').style.display = 'block';
            listDiv.innerHTML = '';
            const myReqs = (APP_DATA.requirements || []).filter(r => r.CreatedBy === user.UserID);
            if(myReqs.length > 0) {
                myReqs.forEach(req => {
                    let awardedInfo = '';
                    if (req.Status === 'Awarded') {
                        const contract = (APP_DATA.awarded || []).find(c => c.RequirementID === req.RequirementID);
                        if(contract) awardedInfo = `<small class="d-block text-muted">Awarded to: ${contract.VendorName} for ₹${contract.AwardedAmount}</small>`;
                    }
                    listDiv.innerHTML += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${req.ProductName}</h6><span class="badge bg-${getBadgeColor(req.Status)}">${req.Status}</span></div>${awardedInfo}</div>`;
                });
            } else {
                listDiv.innerHTML = '<div class="list-group-item">You have not created any requisitions yet.</div>';
            }
            document.getElementById('user-req-status-loader').style.display = 'none';
        }

        document.getElementById('requisition-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Submitting...`;
            const imageFile = document.getElementById('req-image').files[0]; let imageUrl = '';
            if (imageFile) {
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Uploading Image...`;
                const reader = new FileReader(); reader.readAsDataURL(imageFile);
                const base64File = await new Promise((resolve) => { reader.onload = () => resolve(reader.result); });
                const uploadResult = await postData({ action: 'uploadImage', data: { file: base64File, fileName: imageFile.name, mimeType: imageFile.type } });
                if (uploadResult.success) { imageUrl = uploadResult.fileUrl; } 
                else {
                    alert('Image upload failed: ' + uploadResult.error);
                    submitButton.disabled = false; submitButton.textContent = 'Submit for Approval'; return;
                }
            }
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving Requisition...`;
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const selectedVendorIds = Array.from(document.querySelectorAll('#req-vendor-checklist input:checked')).map(input => input.value);
            if (selectedVendorIds.length === 0) {
                alert('Please select at least one vendor.');
                submitButton.disabled = false; submitButton.textContent = 'Submit for Approval'; return;
            }
            const result = await postData({ action: 'createRequisition', data: { ProductName: document.getElementById('req-product-name').value, Quantity: document.getElementById('req-quantity').value, Description: document.getElementById('req-description').value, ImageURL: imageUrl, CreatedBy: currentUser.UserID, vendorIds: selectedVendorIds } });
            if (result.success) {
                alert(result.message); this.reset();
                loadInitialData().then(() => loadUserDashboard());
            } else { alert('Error: ' + result.error); }
            submitButton.disabled = false; submitButton.textContent = 'Submit for Approval';
        });

        // --- UTILITY FUNCTIONS ---
        function getBadgeColor(status) {
            const colors = { 'Awarded': 'primary', 'Accepted': 'success', 'Rejected': 'danger', 'Viewed': 'info', 'Active': 'success', 'Pending Approval': 'warning' };
            return colors[status] || 'secondary';
        }

    </script>
</body>
</html>
