<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcureHub - Final Version</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
            --info-color: #0dcaf0; --warning-color: #ffc107; --danger-color: #dc3545;
            --sidebar-bg: #212529; --sidebar-text: #adb5bd; --sidebar-hover: #343a40;
            --content-bg: #f8f9fa;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.error { background-color: var(--danger-color); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #343a40; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 1rem; }

        .main-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: var(--sidebar-text); padding: 20px; display: flex; flex-direction: column; }
        .sidebar .logo { font-size: 1.6rem; font-weight: 700; text-align: center; color: white; padding-bottom: 20px; border-bottom: 1px solid var(--sidebar-hover); margin-bottom: 20px; }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.3s ease; white-space: nowrap; cursor: pointer; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: var(--primary-color); color: white; }
        .sidebar .nav-link i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid var(--sidebar-hover); padding-top: 15px; text-align: center; }
        .main-content { flex-grow: 1; padding: 25px; overflow-x: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .stat-card { border: none; border-radius: 12px; color: white; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); transition: transform 0.2s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .display-4 { font-weight: 700; }
        .stat-card i.stat-icon { font-size: 3.5rem; opacity: 0.2; }
        .nav-tabs .nav-link.active { background-color: var(--primary-color); color: white; }
        .table-hover tbody tr:hover { cursor: pointer; background-color: #e9ecef; }
        .list-group-item.clickable { cursor: pointer; transition: background-color 0.2s ease; }
        .list-group-item.clickable:hover { background-color: #f0f2f5; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper" class="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4"> </video>
        <div id="login-container" class="card p-4 shadow-lg border-0">
            <h2 class="text-center mb-1"><i class="fas fa-tasks text-primary"></i> ProcureHub</h2>
            <p class="text-center text-muted mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3"><input type="password" id="password" class="form-control" placeholder="Password" required></div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
            <p id="login-error" class="text-danger mt-3 text-center mb-0"></p>
        </div>
    </div>

    <div id="app-container" class="main-container hidden">
        <nav class="sidebar">
            <div class="logo"><i class="fas fa-tasks"></i> ProcureHub</div>
            <div id="nav-links">
                <a class="nav-link admin-nav-item" data-view="admin-dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link admin-nav-item" data-view="admin-requirements-view"><i class="fas fa-file-alt"></i> All Requirements</a>
                <a class="nav-link admin-nav-item" data-view="admin-awarded-view"><i class="fas fa-trophy"></i> Awarded Contracts</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-reqs-view"><i class="fas fa-inbox"></i> Requisition Approvals</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-users-view"><i class="fas fa-user-check"></i> User Approvals</a>
                <a class="nav-link admin-nav-item" data-view="admin-reports-view"><i class="fas fa-chart-pie"></i> Reports</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-dashboard-view"><i class="fas fa-clipboard-list"></i> My Requirements</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-awarded-view"><i class="fas fa-trophy"></i> My Awarded Contracts</a>
                <a class="nav-link user-nav-item" data-view="user-create-req-view"><i class="fas fa-edit"></i> Create Requisition</a>
                <a class="nav-link user-nav-item" data-view="user-status-view"><i class="fas fa-history"></i> My Requisition Status</a>
            </div>
            <div class="user-profile">
                <h6 id="user-name-sidebar"></h6>
                <small id="user-email-sidebar" class="text-muted"></small>
                <button onclick="handleLogout()" class="btn btn-sm btn-outline-light w-100 mt-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="top-header">
                <div class="d-flex align-items-center">
                    <div id="nav-controls" class="me-3 hidden">
                        <button class="btn btn-sm btn-outline-secondary" id="nav-back" title="Back"><i class="fas fa-arrow-left"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="nav-next" title="Next"><i class="fas fa-arrow-right"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="nav-home" title="Home"><i class="fas fa-home"></i></button>
                    </div>
                    <h1 id="header-title" class="h4 mb-0"></h1>
                </div>
            </div>
            <div id="main-view">
                <div id="admin-dashboard-view" class="view hidden">
                    <div class="row g-4 mb-4">
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-primary" onclick="navigateTo('admin-requirements-view')"><div><h5 class="mb-0">Active Tenders</h5><p class="display-4" id="stats-active-tenders">--</p></div><i class="fas fa-file-alt stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-success" onclick="navigateTo('admin-pending-users-view')"><div><h5 class="mb-0">Registered Vendors</h5><p class="display-4" id="stats-registered-vendors">--</p></div><i class="fas fa-users stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-warning"><div><h5 class="mb-0">Pending Bids</h5><p class="display-4" id="stats-pending-bids">--</p></div><i class="fas fa-hourglass-half stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-info" onclick="navigateTo('admin-awarded-view')"><div><h5 class="mb-0">Contracts Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                    <div class="row g-4">
                        <div class="col-md-7"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending Requisitions</h5></div><div id="admin-dashboard-reqs" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;"></div></div></div>
                        <div class="col-md-5"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Recent Bids</h5></div><div id="admin-dashboard-bids" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;"></div></div></div>
                    </div>
                </div>
                <div id="admin-requirements-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">All Requirements</h5><button class="btn btn-sm btn-outline-primary" onclick="downloadAdvancedRequirementsReport()"><i class="fas fa-download me-2"></i>Download Advanced Report</button></div>
                        <div class="card-body">
                            <div class="mb-3 p-3 bg-light border rounded"><h6><i class="fas fa-upload me-2"></i>Bulk Upload</h6><input type="file" id="bulkUploadInput" class="form-control form-control-sm" accept=".csv, .xlsx"><div id="upload-status" class="mt-2 small"></div></div>
                            <div id="admin-req-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table table-hover align-middle" id="admin-req-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Status</th><th>L1 Vendor</th><th>L1 Rate (₹)</th></tr></thead><tbody id="admin-req-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div id="admin-awarded-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Awarded Contracts</h5><button class="btn btn-sm btn-outline-primary" onclick="downloadCSV('AwardedContracts')"><i class="fas fa-download me-2"></i>Download CSV</button></div>
                        <div class="card-body">
                            <div id="admin-awarded-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-awarded-table" style="display:none;"><thead class="table-light"><tr><th>Contract ID</th><th>Product</th><th>Vendor</th><th>Amount (₹)</th><th>Awarded Date</th></tr></thead><tbody id="admin-awarded-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div id="admin-pending-reqs-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending Requisition Approvals</h5></div>
                        <div class="card-body">
                            <div id="admin-pending-reqs-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-pending-reqs-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Created By</th><th>Date</th><th>Action</th></tr></thead><tbody id="admin-pending-reqs-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div id="admin-pending-users-view" class="view hidden">
                    <div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending User Approvals</h5></div>
                        <div class="card-body">
                            <div id="admin-pending-users-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="admin-pending-users-table" style="display:none;"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table></div>
                        </div>
                    </div>
                </div>
                <div id="admin-reports-view" class="view hidden">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white"><h5 class="mb-0">Reports & Analytics</h5></div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6"><div class="card"><div class="card-header">Total Bid Amount per Vendor</div><div class="card-body" style="height: 300px; position: relative;"><canvas id="vendorAmountChart"></canvas></div></div></div>
                                <div class="col-md-6"><div class="card"><div class="card-header">Requirement Status Overview</div><div class="card-body" style="height: 300px; position: relative;"><canvas id="reqStatusChart"></canvas></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="vendor-dashboard-view" class="view hidden">
                     <div class="row g-4 mb-4">
                        <div class="col-md-4"><div class="stat-card bg-info"><div><h5 class="mb-0">Assigned Tenders</h5><p class="display-4" id="vendor-stats-assigned">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-secondary"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="vendor-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-success" onclick="navigateTo('vendor-awarded-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="vendor-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                     <div class="card shadow-sm border-0">
                         <div class="card-header bg-white"><h5 class="mb-0">My Assigned Requirements</h5></div>
                         <div class="card-body">
                            <div class="p-3 bg-light border rounded mb-3"><h6><i class="fas fa-download me-2"></i>Download Bidding History</h6><div class="row g-2 align-items-end"><div class="col-md-4"><label class="form-label form-label-sm">Start Date</label><input type="date" id="startDate" class="form-control form-control-sm"></div><div class="col-md-4"><label class="form-label form-label-sm">End Date</label><input type="date" id="endDate" class="form-control form-control-sm"></div><div class="col-md-4"><button id="download-history-btn" class="btn btn-sm btn-success w-100">Download CSV</button></div></div></div>
                            <div id="vendor-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table table-hover align-middle" id="vendor-req-table" style="display:none;"><thead class="table-light"><tr><th>ID</th><th>Product</th><th>Image</th><th>Status</th><th>My Bid</th><th>L1 Bid</th></tr></thead><tbody id="vendor-req-tbody"></tbody></table></div>
                         </div>
                     </div>
                </div>
                <div id="vendor-awarded-view" class="view hidden">
                     <div class="card shadow-sm border-0">
                         <div class="card-header bg-white"><h5 class="mb-0">My Awarded Contracts</h5></div>
                         <div class="card-body">
                            <div id="vendor-awarded-loader" class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                            <div class="table-responsive"><table class="table align-middle" id="vendor-awarded-table" style="display:none;"><thead class="table-light"><tr><th>Contract ID</th><th>Product</th><th>Amount (₹)</th><th>Awarded Date</th></tr></thead><tbody id="vendor-awarded-tbody"></tbody></table></div>
                         </div>
                     </div>
                </div>
                <div id="user-create-req-view" class="view hidden">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-edit me-2"></i>Create a New Requisition</h5></div>
                        <div class="card-body"><form id="requisition-form"><div class="row"><div class="col-md-6 mb-3"><label for="req-product-name" class="form-label">Product Name</label><input type="text" id="req-product-name" class="form-control" required></div><div class="col-md-6 mb-3"><label for="req-quantity" class="form-label">Quantity</label><input type="number" id="req-quantity" class="form-control" required></div></div><div class="mb-3"><label for="req-description" class="form-label">Description</label><textarea id="req-description" class="form-control" rows="3"></textarea></div><div class="mb-3"><label for="req-image" class="form-label">Reference Image (Optional)</label><input type="file" id="req-image" class="form-control" accept="image/*"></div><h6 class="mt-4">Select Vendors to Notify</h6><div id="req-vendor-checklist" class="mb-3 border rounded p-3" style="max-height: 150px; overflow-y: auto;"><p class="text-muted">Loading vendors...</p></div><button type="submit" class="btn btn-primary w-100 fw-bold">Submit for Approval</button></form></div>
                    </div>
                </div>
                <div id="user-status-view" class="view hidden">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Requisition Status</h5></div>
                        <div id="user-req-status-loader" class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>
                        <div id="user-req-status-list" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-company" class="form-control" placeholder="Company Name (for Vendors)"></div><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Vendor">Vendor</option><option value="User">User</option></select></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bidModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="bidModalTitle">Place Bid</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="bid-form"><input type="hidden" id="bid-req-id"><div class="mb-3"><label for="bidAmount" class="form-label">Bid Amount (₹)</label><input type="number" class="form-control" id="bidAmount" required></div><div class="mb-3"><label for="bidComments" class="form-label">Comments</label><textarea class="form-control" id="bidComments" rows="3"></textarea></div><button type="submit" class="btn btn-primary w-100">Submit Bid</button></form></div></div></div></div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="adminActionModalTitle">Requirement Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="nav nav-tabs" id="admin-modal-tabs"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#view-bids-pane">View Bids</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#assign-vendors-pane">Assign Vendors</button></li></ul><div class="tab-content"><div class="tab-pane fade show active p-3" id="view-bids-pane"><div id="bids-loader" class="text-center p-4"><div class="spinner-border text-success"></div></div><div class="table-responsive"><table class="table table-striped" id="bids-table" style="display:none;"><thead><tr><th>Rank</th><th>Vendor</th><th>Amount (₹)</th><th>Comments</th><th>Status</th><th>Action</th></tr></thead><tbody id="bids-tbody"></tbody></table></div></div><div class="tab-pane fade p-3" id="assign-vendors-pane"><div id="vendors-loader" class="text-center p-4"><div class="spinner-border text-info"></div></div><div id="vendor-list"></div><button class="btn btn-primary mt-3" id="save-assignments-btn">Save Assignments</button></div></div></div></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
</body>
</html>
