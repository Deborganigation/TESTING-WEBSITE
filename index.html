<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S PROCUREMENT</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/purchase-order.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --success-color: #198754;
            --info-color: #0dcaf0; --warning-color: #ffc107; --danger-color: #dc3545;
            --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1; --sidebar-hover: #34495e;
            --content-bg: #f8f9fa;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.info { background-color: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #343a40; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 1rem; }
        
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: #6c757d; }

        .main-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: var(--sidebar-text); padding: 20px; display: flex; flex-direction: column; transition: width 0.3s ease; }
        .sidebar .logo { font-size: 1.6rem; font-weight: 700; text-align: center; color: white; padding-bottom: 20px; border-bottom: 1px solid var(--sidebar-hover); margin-bottom: 20px; }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: all 0.3s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover); color: white; }
        .sidebar .nav-link.active { background-color: var(--primary-color); color: white; }
        .sidebar .nav-link i { margin-right: 15px; width: 20px; text-align: center; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid var(--sidebar-hover); padding-top: 15px; text-align: center; }
        .main-content { flex-grow: 1; padding: 25px; overflow-x: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .stat-card { border: none; border-radius: 12px; color: white; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); transition: transform 0.2s ease; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .display-4 { font-weight: 700; }
        .stat-card i.stat-icon { font-size: 3.5rem; opacity: 0.2; }
        .kpi-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; align-items: center; }
        .kpi-card .kpi-icon { font-size: 2.5rem; padding: 15px; border-radius: 50%; margin-right: 15px; color: #fff; }
        .kpi-card .kpi-info h6 { color: #6c757d; margin-bottom: 0px; text-transform: uppercase; font-size: 0.8rem;}
        .kpi-card .kpi-info p { font-size: 1.8rem; font-weight: 700; margin-bottom: 0; line-height: 1.2;}

        #messaging-view .card { height: calc(100vh - 125px); }
        #chat-list .list-group-item { cursor: pointer; }
        #chat-list .list-group-item.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #chat-messages { display: flex; flex-direction: column; }
        .message-bubble { max-width: 75%; width: fit-content; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; word-wrap: break-word; }
        .message-bubble.sent { background-color: var(--primary-color); color: white; align-self: flex-end; }
        .message-bubble.received { background-color: #e9ecef; color: #212529; align-self: flex-start; }
        .message-bubble small { font-size: 0.75rem; opacity: 0.8; display: block; margin-top: 5px; }
        
        .req-group-header {
            background-color: #e9ecef;
            font-weight: bold;
        }

        /* Select2 Dropdown Style */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(1.5em + 0.75rem + 2px);
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + 0.75rem);
        }

    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4"> </video>
        <div id="login-container" class="card p-4 shadow-lg border-0">
            <h2 class="text-center mb-1"><i class="fas fa-tasks text-primary"></i> DEB'S PROCUREMENT</h2>
            <p class="text-center text-muted mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
            <p id="login-error" class="text-danger mt-3 text-center mb-0"></p>
        </div>
    </div>

    <div id="app-container" class="main-container hidden">
        <nav class="sidebar">
            <div class="logo"><i class="fas fa-tasks"></i> DEB'S PROCUREMENT </div>
            <div id="nav-links">
                <a class="nav-link admin-nav-item" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-reqs-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-inbox"></i> Requisition Approvals</a>
                <a class="nav-link admin-nav-item" data-view="admin-requirements-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-file-alt"></i> All Requirements</a>
                <a class="nav-link admin-nav-item" data-view="admin-bidding-history-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-history"></i> Bidding History</a>
                <a class="nav-link admin-nav-item" data-view="admin-awarded-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-trophy"></i> Awarded Contracts</a>
                <a class="nav-link admin-nav-item" data-view="admin-pending-users-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-user-check"></i> User Approvals</a>
                <a class="nav-link admin-nav-item" data-view="admin-user-control-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-users-cog"></i> User Control</a>
                <a class="nav-link admin-nav-item" data-view="admin-reports-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-chart-pie"></i> Reports & Analytics</a>
                <a class="nav-link admin-nav-item user-nav-item vendor-nav-item" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-comments"></i> Messages</a>
                
                <a class="nav-link vendor-nav-item" data-view="vendor-dashboard-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-clipboard-list"></i> My Requirements</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-my-bids-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-gavel"></i> My Bids</a>
                <a class="nav-link vendor-nav-item" data-view="vendor-awarded-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-trophy"></i> My Awarded Contracts</a>
                
                <a class="nav-link user-nav-item" data-view="user-create-req-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-edit"></i> Create Requisition</a>
                <a class="nav-link user-nav-item" data-view="user-status-view" onclick="navigateTo(this.dataset.view)"><i class="fas fa-history"></i> My Requisition Status</a>
            </div>
            <div class="user-profile">
                <h6 id="user-name-sidebar"></h6>
                <small id="user-email-sidebar" class="text-muted"></small>
                <button onclick="handleLogout()" class="btn btn-sm btn-outline-light w-100 mt-2"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </nav>

        <main class="main-content">
            <div class="top-header">
                <div class="d-flex align-items-center">
                    <div id="nav-controls" class="me-3">
                        <button class="btn btn-sm btn-outline-secondary" id="nav-back" title="Back"><i class="fas fa-arrow-left"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="nav-next" title="Next"><i class="fas fa-arrow-right"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" id="nav-home" title="Home"><i class="fas fa-home"></i></button>
                    </div>
                    <h1 id="header-title" class="h4 mb-0"></h1>
                </div>
                <button class="btn btn-sm btn-outline-info" onclick="handleManualRefresh()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
            </div>
            <div id="main-view">
                <div id="admin-dashboard-view" class="view hidden">
                    <div class="row g-4 mb-4">
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-primary" onclick="navigateTo('admin-requirements-view')"><div><h5 class="mb-0">Active Items</h5><p class="display-4" id="stats-active-tenders">--</p></div><i class="fas fa-file-alt stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-success" onclick="navigateTo('admin-pending-users-view')"><div><h5 class="mb-0">Pending Users</h5><p class="display-4" id="stats-pending-users">--</p></div><i class="fas fa-user-check stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-warning" onclick="navigateTo('admin-bidding-history-view')"><div><h5 class="mb-0">Submitted Bids</h5><p class="display-4" id="stats-pending-bids">--</p></div><i class="fas fa-hourglass-half stat-icon"></i></div></div>
                        <div class="col-lg-3 col-md-6"><div class="stat-card bg-info" onclick="navigateTo('admin-awarded-view')"><div><h5 class="mb-0">Items Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                    <div class="row g-4">
                        <div class="col-md-7"><div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Pending Requisitions</h5><a href="#" class="small" onclick="navigateTo('admin-pending-reqs-view')">View All</a></div><div id="admin-dashboard-reqs" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;"></div></div></div>
                        <div class="col-md-5"><div class="card shadow-sm border-0"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h5 class="mb-0">Recent Bids</h5><a href="#" class="small" onclick="navigateTo('admin-bidding-history-view')">View All</a></div><div id="admin-dashboard-bids" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;"></div></div></div>
                    </div>
                </div>
                
                <div id="admin-pending-reqs-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending Requisition Approvals</h5></div><div class="card-body"><div class="accordion" id="pending-reqs-accordion"></div></div></div></div>
                
                <div id="admin-requirements-view" class="view hidden">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">All Active Requirement Items</h5>
                            <div>
                                <button class="btn btn-success" onclick="handleAdvancedBulkAward()"><i class="fas fa-trophy me-2"></i>Award Selected Items</button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bulkUploadModal"><i class="fas fa-upload me-2"></i>Bulk Upload</button>
                            </div>
                        </div>
                        <div class="card-body"><div class="table-responsive"><table class="table table-hover align-middle" id="admin-req-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="toggleAllInParent(this, 'req-item-checkbox')"></th><th>Req ID</th><th>Item Name</th><th>Item Code</th><th>Qty & Unit</th><th>Images</th><th>Status</th><th>L1 Vendor</th><th>L1 Rate (₹)</th><th>Actions</th></tr></thead><tbody id="admin-req-tbody"></tbody></table></div></div>
                    </div>
                </div>

                <div id="admin-bidding-history-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">All Submitted Bids</h5></div><div class="card-body"><div class="row g-3 align-items-center p-3 bg-light border rounded mb-4"><div class="col-md-5"><label class="form-label form-label-sm">Start Date</label><input type="date" id="bidding-history-start-date" class="form-control form-control-sm"></div><div class="col-md-5"><label class="form-label form-label-sm">End Date</label><input type="date" id="bidding-history-end-date" class="form-control form-control-sm"></div><div class="col-md-2 d-grid"><button class="btn btn-sm btn-success" onclick="downloadBiddingHistoryReport()"><i class="fas fa-download me-2"></i>Download Report</button></div></div><div class="table-responsive"><table class="table align-middle" id="admin-bids-table"><thead class="table-light"><tr><th>Req ID</th><th>Item Name</th><th>Vendor</th><th>Ex-works (₹)</th><th>Freight (₹)</th><th>Total Amount (₹)</th><th>Status</th><th>Date</th></tr></thead><tbody id="admin-bids-tbody"></tbody></table></div></div></div></div>

                <div id="admin-awarded-view" class="view hidden">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Awarded Contracts</h5>
                            <div>
                                <button class="btn btn-danger" onclick="handleBulkReopenModal()"><i class="fas fa-history me-2"></i>Re-open Selected Items</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 align-items-center p-3 bg-light border rounded mb-4">
                                <div class="col-md-5"><label class="form-label form-label-sm">Start Date</label><input type="date" id="awarded-start-date" class="form-control form-control-sm"></div>
                                <div class="col-md-5"><label class="form-label form-label-sm">End Date</label><input type="date" id="awarded-end-date" class="form-control form-control-sm"></div>
                                <div class="col-md-2 d-grid"><button class="btn btn-sm btn-success" onclick="downloadAwardedContractsReport()"><i class="fas fa-download me-2"></i>Download Detailed Report</button></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table align-middle" id="admin-awarded-table">
                                    <thead class="table-light"><tr>
                                        <th><input type="checkbox" onchange="toggleAllInParent(this, 'awarded-item-checkbox')"></th>
                                        <th>Req. ID</th>
                                        <th>Item Name</th>
                                        <th>Item Code</th>
                                        <th>Qty & Unit</th>
                                        <th>Vendor</th>
                                        <th>Awarded Amount (₹)</th>
                                        <th>Awarded Date</th>
                                        <th>Actions</th>
                                    </tr></thead>
                                    <tbody id="admin-awarded-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="admin-reports-view" class="view hidden">
                    <h4 class="mb-4">Procurement Analytics Dashboard</h4>
                     <div class="row g-3 align-items-center p-3 bg-light border rounded mb-4">
                            <div class="col-md-5"><label class="form-label form-label-sm">Start Date</label><input type="date" id="report-start-date" class="form-control form-control-sm"></div>
                            <div class="col-md-5"><label class="form-label form-label-sm">End Date</label><input type="date" id="report-end-date" class="form-control form-control-sm"></div>
                            <div class="col-md-2 d-grid"><button id="report-apply-filter" class="btn btn-primary btn-sm">Apply Filter</button></div>
                     </div>

                     <div class="row g-4 mb-4">
                            <div class="col-lg-3 col-md-6"><div class="kpi-card"><div class="kpi-icon bg-primary"><i class="fas fa-wallet"></i></div><div class="kpi-info"><h6 class>Total Spend</h6><p id="report-total-spend">₹0</p></div></div></div>
                            <div class="col-lg-3 col-md-6"><div class="kpi-card"><div class="kpi-icon bg-success"><i class="fas fa-piggy-bank"></i></div><div class="kpi-info"><h6 class>Cost Savings (L2-L1)</h6><p id="report-cost-savings">₹0</p></div></div></div>
                            <div class="col-lg-3 col-md-6"><div class="kpi-card"><div class="kpi-icon bg-info"><i class="fas fa-gavel"></i></div><div class="kpi-info"><h6 class>Avg. Bids / Item</h6><p id="report-avg-bids">0</p></div></div></div>
                            <div class="col-lg-3 col-md-6"><div class="kpi-card"><div class="kpi-icon bg-warning"><i class="fas fa-clock"></i></div><div class="kpi-info"><h6 class>Avg. Cycle Time</h6><p id="report-cycle-time">0 Days</p></div></div></div>
                     </div>

                     <div class="row g-4">
                            <div class="col-lg-8"><div class="card h-100 shadow-sm"><div class="card-header">Spend by Vendor</div><div class="card-body"><canvas id="vendorSpendChart"></canvas></div></div></div>
                            <div class="col-lg-4"><div class="card h-100 shadow-sm"><div class="card-header">Item Status Overview</div><div class="card-body d-flex align-items-center justify-content-center"><canvas id="itemStatusChart" style="max-height: 300px;"></canvas></div></div></div>
                            <div class="col-12"><div class="card h-100 shadow-sm"><div class="card-header">Spend by Product</div><div class="card-body"><canvas id="productSpendChart"></canvas></div></div></div>
                            <div class="col-12"><div class="card h-100 shadow-sm"><div class="card-header">Vendor Performance Leaderboard</div><div class="card-body table-responsive"><table class="table table-sm" id="vendor-performance-table"><thead><tr><th>Vendor</th><th>Bids Submitted</th><th>Contracts Won</th><th>Win Rate</th><th>Total Value Won (₹)</th></tr></thead><tbody></tbody></table></div></div></div>
                     </div>
                </div>

                <div id="admin-pending-users-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">Pending User Approvals</h5></div><div class="card-body"><div class="table-responsive"><table class="table align-middle" id="admin-pending-users-table"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table></div></div></div></div>
                <div id="admin-user-control-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">User Control Center</h5></div><div class="card-body"><div class="table-responsive"><table class="table align-middle" id="admin-users-table"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>GSTIN</th><th>Action</th></tr></thead><tbody id="admin-users-tbody"></tbody></table></div></div></div></div>
                
                <div id="messaging-view" class="view hidden">
                    <div class="card shadow-sm border-0">
                        <div class="row g-0 h-100">
                            <div class="col-lg-4 col-12 border-end">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Conversations</h5>
                                </div>
                                <div id="chat-list" class="list-group list-group-flush" style="overflow-y: auto; height: calc(100% - 57px);">
                                    </div>
                            </div>
                            <div class="col-lg-8 col-12 d-flex flex-column">
                                <div id="chat-main" class="h-100">
                                    <div id="chat-welcome" class="d-flex align-items-center justify-content-center h-100">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-comments fa-3x mb-3"></i>
                                            <p>Select a conversation to start messaging.</p>
                                        </div>
                                    </div>
                                    <div id="chat-window" class="d-none h-100 d-flex flex-column">
                                        <div class="card-header bg-white d-flex align-items-center border-bottom">
                                            <h5 id="chat-with-name" class="mb-0"></h5>
                                        </div>
                                        <div id="chat-messages" class="card-body p-4" style="overflow-y: auto; flex-grow: 1;">
                                            </div>
                                        <div class="card-footer bg-light p-3 border-top">
                                            <form id="message-form" class="d-flex">
                                                <input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off" required>
                                                <button type="submit" class="btn btn-primary ms-2"><i class="fas fa-paper-plane"></i></button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vendor-dashboard-view" class="view hidden">
                    <div class="row g-4 mb-4">
                        <div class="col-md-4"><div class="stat-card bg-info" onclick="navigateTo('vendor-dashboard-view')"><div><h5 class="mb-0">Assigned Items</h5><p class="display-4" id="vendor-stats-assigned">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-secondary" onclick="navigateTo('vendor-my-bids-view')"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="vendor-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div>
                        <div class="col-md-4"><div class="stat-card bg-success" onclick="navigateTo('vendor-awarded-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="vendor-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    </div>
                    
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">My Active Requirements</h5>
                            <button class="btn btn-primary" onclick="openCrossRequisitionBidModal()">
                                <i class="fas fa-gavel me-2"></i>Bid on Selected Items
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" id="vendor-reqs-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th><input type="checkbox" onchange="toggleAllInParent(this, 'vendor-item-checkbox')"></th>
                                            <th>Item Name</th>
                                            <th>Qty & Unit</th>
                                            <th>Images</th>
                                            <th>Freight</th>
                                            <th>My Bid Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vendor-reqs-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="vendor-my-bids-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">My Submitted Bids</h5></div><div class="card-body"><div class="table-responsive"><table class="table align-middle" id="vendor-bids-table"><thead class="table-light"><tr><th>Req. ID</th><th>Item Name</th><th>My Bid Amount (₹)</th><th>My Rank</th><th>Status</th><th>Submitted On</th></tr></thead><tbody id="vendor-bids-tbody"></tbody></table></div></div></div></div>
                <div id="vendor-awarded-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0">My Awarded Contracts</h5></div><div class="card-body"><div class="table-responsive"><table class="table align-middle" id="vendor-awarded-table"><thead class="table-light"><tr><th>Contract ID</th><th>Item Name</th><th>My Awarded Amount (₹)</th><th>Awarded Date</th></tr></thead><tbody id="vendor-awarded-tbody"></tbody></table></div></div></div></div>
                <div id="user-create-req-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-edit me-2"></i>Create a New Requisition</h5></div><div class="card-body"><form id="requisition-form"><div id="requisition-items-container"></div><button type="button" class="btn btn-outline-secondary w-100 mb-3" onclick="addRequisitionItem()"><i class="fas fa-plus me-2"></i>Add another item</button><div class="card p-3 mb-3"><h6 class="mt-2 d-flex justify-content-between align-items-center">Select Vendors to Notify<div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="select-all-vendors-user"><label class="form-check-label small" for="select-all-vendors-user">Select All</label></div></h6><div id="req-vendor-checklist" class="border rounded p-3" style="max-height: 150px; overflow-y: auto;"></div></div><button type="submit" class="btn btn-primary w-100 fw-bold">Submit Requisition for Approval</button></form></div></div></div>
                <div id="user-status-view" class="view hidden"><div class="card shadow-sm border-0"><div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Requisition Status</h5></div><div class="card-body"><div id="user-req-status-list"></div></div></div></div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="User">User</option><option value="Vendor">Vendor</option></select></div><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div><div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div><div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="adminActionModalTitle">Item Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="adminActionModalBody"><div id="req-image-preview" class="text-center my-3"></div><div class="table-responsive"><table class="table table-striped" id="bids-table"><thead><tr><th><input type="checkbox" class="bid-checkbox-all" onchange="toggleAllInParent(this, 'bid-checkbox')"></th><th>Rank</th><th>Vendor</th><th>Ex-works (₹)</th><th>Freight (₹)</th><th>Total Amount (₹)</th><th>Status</th></tr></thead><tbody id="bids-tbody"></tbody></table></div></div><div class="modal-footer"><div class="w-100"><div class="mb-2"><label class="form-label">Remarks (Mandatory for Action)</label><textarea id="admin-action-remarks" class="form-control" rows="2"></textarea></div><div class="d-flex justify-content-end"><button type="button" class="btn btn-warning me-2" id="reopen-bidding-btn">Re-open Bidding</button><button type="button" class="btn btn-secondary me-auto" onclick="selectAllL1Bids()">Select All L1 Bids</button><button type="button" class="btn btn-success" onclick="handleBulkAwardSubmit()">Award/Re-award Selected</button></div></div></div></div></div></div>
    <div class="modal fade" id="bulkBidModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title" id="bulkBidModalTitle">Bulk Bid Submission</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="bulk-bid-form"><div id="bulk-bid-items-container" class="table-responsive"></div><button type="submit" class="btn btn-primary w-100 mt-3">Submit All Bids</button></form></div></div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="edit-userid"><div class="mb-2"><label class="form-label">Full Name</label><input type="text" id="edit-fullname" class="form-control" required></div><div class="mb-2"><label class="form-label">Email</label><input type="email" id="edit-email" class="form-control" required></div><div class="mb-2"><label class="form-label">Role</label><select id="edit-role" class="form-select" required><option value="User">User</option><option value="Vendor">Vendor</option><option value="Admin">Admin</option></select></div><div class="mb-2"><label class="form-label">Company Name</label><input type="text" id="edit-company" class="form-control"></div><div class="mb-2"><label class="form-label">Contact Number</label><input type="text" id="edit-contact" class="form-control"></div><div class="mb-2"><label class="form-label">GSTIN</label><input type="text" id="edit-gstin" class="form-control"></div><div class="mb-2"><label class="form-label">New Password (Optional)</label><input type="text" id="edit-password" class="form-control" placeholder="Leave blank to keep unchanged"></div><button type="submit" class="btn btn-success w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Bulk Upload Requirements</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"> <p>Please upload an Excel file (.xlsx) with the required columns. <a href="#" onclick="downloadBulkTemplate()">Download Template</a></p><hr> <form id="bulk-upload-form"> <div class="mb-3"> <label for="bulk-upload-file" class="form-label">Select Excel File</label> <input class="form-control" type="file" id="bulk-upload-file" accept=".xlsx, .xls" required> </div> <div class="mb-3"> <label class="form-label d-flex justify-content-between"><span>Select Vendors to Notify</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="select-all-vendors-bulk"><label class="form-check-label small" for="select-all-vendors-bulk">Select All</label></div></label> <div id="bulk-vendor-checklist" class="border rounded p-3" style="max-height: 150px; overflow-y: auto;"></div> </div> <button type="submit" class="btn btn-success w-100">Upload and Submit</button> </form> </div></div></div></div>
    <div class="modal fade" id="assignVendorsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="assignVendorModalTitle">Assign Vendors</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="assign-vendor-item-id"><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="assign-vendor-select-all" onchange="toggleAllInParent(this, 'assign-vendor-checkbox')"><label class="form-check-label" for="assign-vendor-select-all">Select All Vendors</label></div><hr><div id="assign-vendor-checklist" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="handleUpdateVendorAssignments()">Save changes</button></div></div></div></div>
    <div class="modal fade" id="advancedBulkAwardModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title" id="advancedBulkAwardModalTitle">Advanced Bulk Award</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted">Select one winning bid for each item you wish to award.</p><div class="accordion" id="advanced-bulk-award-modal-body"></div></div><div class="modal-footer"><div class="w-100"><div class="mb-2"><label class="form-label">Remarks (Mandatory)</label><textarea id="advanced-bulk-award-remarks" class="form-control" rows="2" placeholder="e.g., Awarded based on quality and price."></textarea></div><div class="d-flex justify-content-end"><button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" onclick="handleSubmitAdvancedBulkAward()">Submit Awards</button></div></div></div></div></div></div>

    <div class="modal fade" id="reopenBiddingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Re-open Bidding</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reopen-item-ids">
                    <div class="mb-3">
                        <label for="reopen-remarks" class="form-label"><strong>Remarks (Mandatory)</strong></label>
                        <textarea id="reopen-remarks" class="form-control" rows="2" placeholder="Reason for re-opening bids..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>Select Vendors for New Bidding Round</span>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="reopen-select-all-vendors" onchange="toggleAllInParent(this, 'reopen-vendor-checkbox')">
                                <label class="form-check-label small" for="reopen-select-all-vendors">Select All</label>
                            </div>
                        </label>
                        <div id="reopen-vendor-checklist" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitReopenBidding()">Confirm & Re-open</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbx2xpgPf5qChcutumFO6BX9lsfjMhnxRMmd2pKCNgkefxSpQaHEpC8BL-8-XT2OiMRNWw/exec';
        const PRODUCT_DATA_URL = 'https://script.google.com/macros/s/AKfycby3IzOVIOHdlJrWMPlpdARP-EQ5ve8xhKDNAN2iTWEZwPnY2Y3-tali3zTD4CnBgHyLOw/exec';

        let APP_DATA = {};
        let PRODUCT_LIST = []; 
        let LOCATION_DROPDOWN_DATA = [];
        let loginWrapper, appContainer, mainView, headerTitle;
        let registerModal, adminActionModal, bulkBidModal, editUserModal, bulkUploadModal, assignVendorsModal, advancedBulkAwardModal, reopenBiddingModal;
        let vendorSpendChart, itemStatusChart, productSpendChart;
        let chatPollingInterval = null;

        const navHistory = {
            stack: [], forwardStack: [],
            push(viewId) { if (this.stack.length === 0 || this.stack[this.stack.length - 1] !== viewId) { this.stack.push(viewId); this.forwardStack = []; } },
            back() { if (this.stack.length > 1) { this.forwardStack.push(this.stack.pop()); return this.stack[this.stack.length - 1]; } return null; },
            forward() { if (this.forwardStack.length > 0) { const nextView = this.forwardStack.pop(); this.stack.push(nextView); return nextView; } return null; }
        };
        
        // =================================================================
        // =========== 1. INITIALIZATION & CORE FUNCTIONS =================
        // =================================================================
        window.onload = () => {
            loginWrapper = document.getElementById('login-wrapper');
            appContainer = document.getElementById('app-container');
            mainView = document.getElementById('main-view');
            headerTitle = document.getElementById('header-title');
            
            try {
                registerModal = new bootstrap.Modal('#registerModal');
                adminActionModal = new bootstrap.Modal('#adminActionModal');
                bulkBidModal = new bootstrap.Modal('#bulkBidModal');
                editUserModal = new bootstrap.Modal('#editUserModal');
                bulkUploadModal = new bootstrap.Modal('#bulkUploadModal');
                assignVendorsModal = new bootstrap.Modal('#assignVendorsModal');
                advancedBulkAwardModal = new bootstrap.Modal('#advancedBulkAwardModal');
                reopenBiddingModal = new bootstrap.Modal('#reopenBiddingModal');
            } catch (e) { console.error("Error initializing modals:", e); }
            
            if (sessionStorage.getItem('loggedInUser')) {
                setupUIForRole(JSON.parse(sessionStorage.getItem('loggedInUser')));
            }
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegistration);
            document.getElementById('requisition-form').addEventListener('submit', handleRequisitionSubmit);
            document.getElementById('reg-role').addEventListener('change', handleRoleChange);
            document.getElementById('bulk-bid-form').addEventListener('submit', handleBulkBidSubmit);
            document.getElementById('edit-user-form').addEventListener('submit', handleUserUpdateSubmit);
            document.getElementById('bulk-upload-form').addEventListener('submit', handleBulkUpload);
            document.querySelector('#bulkUploadModal').addEventListener('shown.bs.modal', loadVendorsForBulkUpload);
            document.getElementById('togglePassword').addEventListener('click', function () {
                const passwordInput = document.getElementById('password');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type); this.classList.toggle('fa-eye-slash');
            });
            document.getElementById('nav-back').addEventListener('click', () => { const prev = navHistory.back(); if(prev) navigateTo(prev, true); });
            document.getElementById('nav-next').addEventListener('click', () => { const next = navHistory.forward(); if(next) navigateTo(next, true); });
            document.getElementById('nav-home').addEventListener('click', () => navigateTo(JSON.parse(sessionStorage.getItem('loggedInUser'))?.Role ? { 'Admin': 'admin-dashboard-view', 'Vendor': 'vendor-dashboard-view', 'User': 'user-create-req-view' }[JSON.parse(sessionStorage.getItem('loggedInUser')).Role] : ''));
        };

        async function getData(sheetName, forceRefresh = false) {
            if (APP_DATA[sheetName] && !forceRefresh) return APP_DATA[sheetName];
            showLoader();
            try {
                const response = await fetch(`${API_URL}?sheet=${sheetName}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.success) { APP_DATA[sheetName] = result.data; return result.data; }
                throw new Error(result.error || `Failed to parse data for ${sheetName}`);
            } catch (error) { 
                console.error(`Failed to fetch ${sheetName}:`, error);
                showToast(`Failed to load ${sheetName} data.`, 'error');
                return null; 
            } finally { hideLoader(); }
        }
        
        async function getDataSilent(sheetName) {
            try {
                const response = await fetch(`${API_URL}?sheet=${sheetName}&t=${new Date().getTime()}`);
                if (!response.ok) return APP_DATA[sheetName] || null;
                const result = await response.json();
                if (result.success) { 
                    APP_DATA[sheetName] = result.data; 
                    return result.data; 
                }
                return APP_DATA[sheetName] || null;
            } catch (error) {
                console.warn(`Silent fetch for ${sheetName} failed:`, error);
                return APP_DATA[sheetName] || null;
            }
        }
        
        async function fetchProductList() {
            if (PRODUCT_LIST.length > 0) return;
            showLoader();
            try {
                // --- CACHE BUSTER ADDED HERE ---
                const response = await fetch(`${PRODUCT_DATA_URL}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                
                // Check if the script returned an error object
                if (result && result.error) {
                    throw new Error(`Error from product script: ${result.error}`);
                }

                if (result && Array.isArray(result)) {
                    PRODUCT_LIST = result;
                } else {
                    throw new Error('Failed to parse product data. Expected an array.');
                }
            } catch (error) {
                console.error("Failed to fetch product list:", error);
                showToast('Could not load product master data. Please try again.', 'error');
                PRODUCT_LIST = [];
            } finally {
                hideLoader();
            }
        }

        async function fetchLocationDropdownData() {
            if (LOCATION_DROPDOWN_DATA.length > 0) return;
            try {
                const locations = await getData("DropdownData", true);
                if(locations && locations.length > 0) {
                    const header = Object.keys(locations[0])[0];
                    LOCATION_DROPDOWN_DATA = locations.map(row => row[header]).filter(Boolean);
                } else {
                    throw new Error('DropdownData sheet is empty or could not be loaded.');
                }
            } catch(error) {
                console.error("Failed to fetch location data:", error);
                showToast('Could not load delivery locations.', 'error');
            }
        }

        async function postData(payload) {
            showLoader();
            try {
                const response = await fetch(API_URL, { 
                    method: 'POST', body: JSON.stringify(payload), 
                    headers: {'Content-Type': 'text/plain;charset=utf-8'}, redirect: 'follow' 
                });
                if (!response.ok) throw new Error(`Network response was not ok, status: ${response.status}`);
                const result = await response.json();
                if (result.success === false) throw new Error(result.error || 'Unknown backend error');
                return result;
            } catch (error) { 
                console.error('POST Error:', error);
                showToast(`Operation Failed: ${error.message}`, 'error');
                return { success: false, error: error.message }; 
            } finally {
                hideLoader();
            }
        }
        
        function navigateTo(viewId, fromHistory = false) {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
            mainView.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(viewId);
            if(targetView) targetView.classList.remove('hidden');
            
            document.querySelectorAll('#nav-links .nav-link').forEach(link => link.classList.remove('active'));
            const navLinkElement = document.querySelector(`#nav-links .nav-link[data-view="${viewId}"]`);
            if (navLinkElement) {
                navLinkElement.classList.add('active');
                headerTitle.textContent = navLinkElement.textContent.trim();
            }
            if(!fromHistory) navHistory.push(viewId);
            updateNavControls();
            
            const viewLoadFunctions = {
                'admin-dashboard-view': loadAdminDashboard, 'admin-pending-reqs-view': loadPendingRequisitions,
                'admin-requirements-view': loadAdminRequirements, 'admin-bidding-history-view': loadBiddingHistory,
                'admin-awarded-view': loadAdminAwardedContracts, 'admin-pending-users-view': loadPendingUsers,
                'admin-user-control-view': loadUserControl, 'admin-reports-view': loadAdminReports,
                'vendor-dashboard-view': loadVendorDashboard, 'vendor-awarded-view': loadVendorAwarded,
                'vendor-my-bids-view': loadVendorMyBidsView,
                'user-create-req-view': loadUserCreateReq, 'user-status-view': loadUserStatusView,
                'messaging-view': loadMessages
            };
            viewLoadFunctions[viewId]?.();
        }
        
        function updateNavControls() {
            document.getElementById('nav-back').disabled = navHistory.stack.length <= 1;
            document.getElementById('nav-next').disabled = navHistory.forwardStack.length === 0;
        }

        async function handleManualRefresh() {
            const currentView = navHistory.stack[navHistory.stack.length - 1];
            if (currentView) {
                showToast('Refreshing data...', 'info');
                APP_DATA = {};
                if (JSON.parse(sessionStorage.getItem('loggedInUser')).Role === 'User') {
                    PRODUCT_LIST = [];
                    LOCATION_DROPDOWN_DATA = [];
                    await Promise.all([fetchProductList(), fetchLocationDropdownData()]);
                }
                navigateTo(currentView, true);
            }
        }

        // =================================================================
        // =========== 2. LOGIN, LOGOUT & REGISTRATION =====================
        // =================================================================
        async function handleLogin(e) { e.preventDefault(); document.getElementById('login-error').textContent = 'Authenticating...'; const users = await getData('Users', true); if (!users) { document.getElementById('login-error').textContent = 'Could not connect.'; return; } const emailInput = document.getElementById('email').value.toLowerCase(); const passwordInput = document.getElementById('password').value; const foundUser = users.find(user => user.Email.toLowerCase() === emailInput && user.Password.toString() === passwordInput.toString()); if (foundUser) { sessionStorage.setItem('loggedInUser', JSON.stringify(foundUser)); APP_DATA = {}; await setupUIForRole(foundUser); } else { document.getElementById('login-error').textContent = 'Invalid email or password.'; } }
        function handleLogout() { sessionStorage.clear(); APP_DATA = {}; PRODUCT_LIST = []; LOCATION_DROPDOWN_DATA = []; window.location.reload(); }
        function handleRoleChange() { const role = document.getElementById('reg-role').value; const companyWrapper = document.getElementById('reg-company-wrapper'); const gstinWrapper = document.getElementById('reg-gstin-wrapper'); const companyInput = document.getElementById('reg-company');[companyWrapper, gstinWrapper].forEach(el => el.classList.add('hidden')); companyInput.required = false; if (role === 'Vendor') { companyWrapper.classList.remove('hidden'); gstinWrapper.classList.remove('hidden'); companyInput.required = true; } }
        async function handleRegistration(e) { e.preventDefault(); const result = await postData({ action: 'submitRegistration', data: { Role: document.getElementById('reg-role').value, FullName: document.getElementById('reg-fullname').value, Email: document.getElementById('reg-email').value, Password: document.getElementById('reg-password').value, ContactNumber: document.getElementById('reg-contact').value, CompanyName: document.getElementById('reg-company').value, GSTIN: document.getElementById('reg-gstin').value } }); if (result.success) { showToast(result.message, 'success'); registerModal.hide(); e.target.reset(); } }
        async function setupUIForRole(user) {
            loginWrapper.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('user-name-sidebar').textContent = user.FullName;
            document.getElementById('user-email-sidebar').textContent = user.Email;
            document.querySelectorAll('#nav-links .nav-link').forEach(link => link.style.display = 'none');
            document.querySelectorAll(`.${user.Role.toLowerCase()}-nav-item`).forEach(link => link.style.display = 'flex');
            if (user.Role === 'User') {
                await Promise.all([fetchProductList(), fetchLocationDropdownData()]);
            }
            const defaultView = { 'Admin': 'admin-dashboard-view', 'Vendor': 'vendor-dashboard-view', 'User': 'user-create-req-view' }[user.Role];
            navigateTo(defaultView);
        }

        // =================================================================
        // =========== 3. ADMIN PANEL FUNCTIONS ============================
        // =================================================================
        async function loadAdminDashboard() { const [reqItems, pendingUsers, bids, awarded, allUsers] = await Promise.all([ getData('RequisitionItems', true), getData('PendingUsers', true), getData('Bids', true), getData('AwardedContracts', true), getData('Users') ]); document.getElementById('stats-active-tenders').textContent = (reqItems || []).filter(r => r.Status === 'Active').length; document.getElementById('stats-pending-users').textContent = (pendingUsers || []).length; document.getElementById('stats-pending-bids').textContent = (bids || []).filter(b => b.BidStatus === 'Submitted').length; document.getElementById('stats-awarded-contracts').textContent = (awarded || []).length; const reqsContainer = document.getElementById('admin-dashboard-reqs'); const pendingReqs = (reqItems || []).filter(r => r.Status === 'Pending Approval').slice(0, 5); reqsContainer.innerHTML = pendingReqs.length > 0 ? '' : '<div class="list-group-item">No pending requisitions.</div>'; pendingReqs.forEach(req => { const creator = (allUsers || []).find(u => u.UserID === req.CreatedBy)?.FullName || 'N/A'; reqsContainer.innerHTML += `<a href="#" onclick="navigateTo('admin-pending-reqs-view')" class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${req.ItemName}</h6><small>${new Date(req.CreatedAt).toLocaleDateString()}</small></div><p class="mb-1 small">Req ID: ${req.RequisitionID.split('-')[1]}-${req.ItemSLNo} | By: ${creator}</p></a>`; }); const bidsContainer = document.getElementById('admin-dashboard-bids'); const recentBids = (bids || []).sort((a,b) => new Date(b.SubmittedAt) - new Date(a.SubmittedAt)).slice(0, 5); bidsContainer.innerHTML = recentBids.length > 0 ? '' : '<div class="list-group-item">No recent bids.</div>'; recentBids.forEach(bid => { const vendor = (allUsers || []).find(u => u.UserID === bid.VendorID)?.FullName || 'N/A'; const item = (reqItems || []).find(i => i.ItemID === bid.ItemID); bidsContainer.innerHTML += `<a href="#" onclick="openAdminActionModalByItemId('${bid.ItemID}')" class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${item?.ItemName || 'Item'}</h6><small>${formatCurrency(bid.BidAmount)}</small></div><p class="mb-1 small">By: ${vendor} on ${new Date(bid.SubmittedAt).toLocaleDateString()}</p></a>`; }); }
        async function loadPendingRequisitions() { const accordion = document.getElementById('pending-reqs-accordion'); accordion.innerHTML = `<div class="text-center p-4">Loading...</div>`; const [items, users, requisitions, assignments] = await Promise.all([getData('RequisitionItems', true), getData('Users'), getData('Requisitions'), getData('RequisitionAssignments')]); const pendingItems = (items || []).filter(item => item.Status === 'Pending Approval'); if (pendingItems.length === 0) { accordion.innerHTML = `<div class="alert alert-info">No requisitions pending approval.</div>`; return; } const groupedByReqId = pendingItems.reduce((acc, item) => { (acc[item.RequisitionID] = acc[item.RequisitionID] || []).push(item); return acc; }, {}); accordion.innerHTML = ''; for (const reqId in groupedByReqId) { const reqItems = groupedByReqId[reqId]; const creator = users.find(u => u.UserID === reqItems[0].CreatedBy)?.FullName || 'N/A'; const createdDate = new Date(reqItems[0].CreatedAt).toLocaleDateString(); const itemsHTML = reqItems.map(item => `<li class="list-group-item"><input class="form-check-input me-2 item-check-box" type="checkbox" value="${item.ItemID}" checked><label class="form-check-label">${item.ItemSLNo}. ${item.ItemName} (${item.Quantity} ${item.Unit})</label></li>`).join(''); const allVendors = users.filter(v => v.Role === 'Vendor'); const suggestedVendorIds = (assignments || []).filter(a => a.RequisitionID === reqId).map(a => a.VendorID); const vendorsHTML = allVendors.map(v => { const isSuggested = suggestedVendorIds.includes(String(v.UserID)); return `<div class="form-check form-check-inline"><input class="form-check-input vendor-assign-check" type="checkbox" id="vendor-${reqId}-${v.UserID}" value="${v.UserID}" ${isSuggested ? 'checked' : ''}><label class="form-check-label" for="vendor-${reqId}-${v.UserID}">${v.FullName} ${isSuggested ? '<span class="badge bg-info small">Suggested</span>': ''}</label></div>`}).join(''); accordion.innerHTML += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${reqId}">Req ID: ${reqId.split('-')[1]} (By: ${creator} on ${createdDate}) - ${reqItems.length} items</button></h2><div id="collapse-${reqId}" class="accordion-collapse collapse" data-bs-parent="#pending-reqs-accordion"><div class="accordion-body"><h6>Select items to approve:</h6><ul class="list-group mb-3"><li class="list-group-item list-group-item-light"><input class="form-check-input me-2" type="checkbox" onchange="toggleAllInParent(this, 'item-check-box')" checked>Select All Items</li>${itemsHTML}</ul><h6 class="d-flex justify-content-between"><span>Assign vendors:</span><div class="form-check form-check-inline"><input class="form-check-input me-2" type="checkbox" onchange="toggleAllInParent(this, 'vendor-assign-check')"><label>Select All</label></div></h6><div class="border rounded p-2">${vendorsHTML}</div><button class="btn btn-success mt-3" onclick="handleBulkApproval('${reqId}')">Process Selected Items</button></div></div></div>`; } }
        async function loadAdminRequirements() { const tbody = document.getElementById('admin-req-tbody'); tbody.innerHTML = `<tr><td colspan="10" class="text-center">Loading...</td></tr>`; const [reqItems, bids, users] = await Promise.all([getData('RequisitionItems', true), getData('Bids'), getData('Users')]); tbody.innerHTML = ''; const activeItems = (reqItems || []).filter(item => ['Active', 'Bidding Closed'].includes(item.Status)); activeItems.forEach(item => { const bidsForItem = (bids || []).filter(b => b.ItemID === item.ItemID).sort((a,b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount)); const l1Bid = bidsForItem[0]; const l1Vendor = l1Bid ? users.find(u => u.UserID === l1Bid.VendorID) : null; const row = document.createElement('tr'); row.dataset.itemId = item.ItemID; row.innerHTML = `<td><input type="checkbox" class="form-check-input req-item-checkbox"></td><td>${item.RequisitionID.split('-')[1]}-${item.ItemSLNo}</td><td>${item.ItemName}</td><td>${item.ItemCode}</td><td>${item.Quantity} ${item.Unit}</td><td>${createImageLinks(item)}</td><td><span class="badge bg-success">${item.Status}</span></td><td>${l1Vendor ? l1Vendor.FullName : 'No Bids'}</td><td>${l1Bid ? formatCurrency(l1Bid.BidAmount) : '-'}</td><td><div class="btn-group"><button class="btn btn-sm btn-info" onclick="openAdminActionModalByItemId('${item.ItemID}')">View Bids</button><button class="btn btn-sm btn-secondary" onclick="openAssignVendorsModal('${item.ItemID}')">Assign</button></div></td>`; tbody.appendChild(row); }); }
        async function loadBiddingHistory() { const tbody = document.getElementById('admin-bids-tbody'); tbody.innerHTML = `<tr><td colspan="8" class="text-center">Loading...</td></tr>`; const [bids, items, users] = await Promise.all([getData('Bids', true), getData('RequisitionItems'), getData('Users')]); tbody.innerHTML = ''; (bids || []).sort((a,b) => new Date(b.SubmittedAt) - new Date(a.SubmittedAt)).forEach(bid => { const item = items.find(i => i.ItemID === bid.ItemID) || {}; const vendor = users.find(u => u.UserID === bid.VendorID) || {}; tbody.innerHTML += `<tr><td>${item.RequisitionID ? `${item.RequisitionID.split('-')[1]}-${item.ItemSLNo}` : 'N/A'}</td><td>${item.ItemName || 'N/A'}</td><td>${vendor.FullName || 'N/A'}</td><td>${formatCurrency(bid.ExWorksRate)}</td><td>${formatCurrency(bid.FreightRate)}</td><td><strong>${formatCurrency(bid.BidAmount)}</strong></td><td><span class="badge bg-${getBadgeColor(bid.BidStatus)}">${bid.BidStatus}</span></td><td>${new Date(bid.SubmittedAt).toLocaleString()}</td></tr>`; }); }
        
        async function loadAdminAwardedContracts() {
            const tbody = document.getElementById('admin-awarded-tbody');
            tbody.innerHTML = `<tr><td colspan="9" class="text-center">Loading...</td></tr>`;
            const awarded = await getData('AwardedContracts', true);
            if (!awarded) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Could not load awarded contracts.</td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            awarded.forEach(c => {
                tbody.innerHTML += `<tr>
                    <td><input type="checkbox" class="form-check-input awarded-item-checkbox" data-item-id="${c.ItemID}"></td>
                    <td>${c.RequisitionID.split('-')[1]}</td>
                    <td>${c.ItemName}</td>
                    <td>${c.ItemCode}</td>
                    <td>${c.Quantity} ${c.Unit}</td>
                    <td>${c.VendorName}</td>
                    <td>${formatCurrency(c.AwardedAmount)}</td>
                    <td>${new Date(c.AwardedDate).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="openAdminActionModalByItemId('${c.ItemID}')">View Bids</button>
                            <button class="btn btn-sm btn-danger" onclick="handleSingleReopenBidding('${c.ItemID}')">Re-open</button>
                        </div>
                    </td>
                </tr>`;
            });
        }
        
        async function loadPendingUsers() { const tbody = document.getElementById('admin-pending-users-tbody'); tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`; const pendingUsers = await getData('PendingUsers', true); tbody.innerHTML = ''; (pendingUsers || []).forEach(user => { tbody.innerHTML += `<tr><td>${user.FullName}</td><td>${user.Email}</td><td>${user.Role}</td><td>${user.CompanyName || '-'}</td><td>${user.ContactNumber || '-'}</td><td><button class="btn btn-sm btn-success" onclick="approveUser('${user.TempID}', '${user.Email}', '${user.FullName}')">Approve</button></td></tr>`; }); }
        async function loadUserControl() { const tbody = document.getElementById('admin-users-tbody'); tbody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`; const users = await getData('Users', true); tbody.innerHTML = ''; (users || []).forEach(user => { tbody.innerHTML += `<tr><td>${user.FullName}</td><td>${user.Email}</td><td>${user.Role}</td><td>${user.CompanyName || '-'}</td><td>${user.ContactNumber || '-'}</td><td>${user.GSTIN || '-'}</td><td><button class="btn btn-sm btn-primary" onclick='openEditUserModal(${JSON.stringify(user)})'>Edit</button></td></tr>`; }); }
        async function loadAdminReports() { showToast('Loading analytical data...', 'info'); await Promise.all([ getData('AwardedContracts', true), getData('RequisitionItems', true), getData('Bids', true), getData('Users', true) ]); document.getElementById('report-apply-filter').onclick = updateReportView; updateReportView(); }

        // =================================================================
        // =========== 4. VENDOR PANEL FUNCTIONS ===========================
        // =================================================================
        
        async function loadVendorDashboard() { 
            const tbody = document.getElementById('vendor-reqs-tbody');
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`; 
            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); 
            const [items, assignments, bids, awarded] = await Promise.all([getData('RequisitionItems', true), getData('RequisitionAssignments'), getData('Bids'), getData('AwardedContracts')]); 
            
            const myBids = (bids || []).filter(b => b.VendorID === currentUser.UserID); 
            document.getElementById('vendor-stats-submitted').textContent = myBids.length; 
            document.getElementById('vendor-stats-won').textContent = (awarded || []).filter(c => c.VendorID === currentUser.UserID).length; 
            
            const myAssignmentIds = new Set((assignments || []).filter(a => a.VendorID === currentUser.UserID).map(a => a.RequisitionID)); 
            const myItems = (items || []).filter(item => myAssignmentIds.has(item.RequisitionID) && item.Status === 'Active'); 
            document.getElementById('vendor-stats-assigned').textContent = myItems.length; 
            
            if (myItems.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="6" class="text-center alert alert-info">No active requirements assigned.</td></tr>`; 
                return; 
            } 
            
            const groupedByReqId = myItems.reduce((acc, item) => {
                (acc[item.RequisitionID] = acc[item.RequisitionID] || []).push(item);
                return acc;
            }, {});
            
            tbody.innerHTML = '';
            for (const reqId in groupedByReqId) {
                const reqItems = groupedByReqId[reqId];
                tbody.innerHTML += `<tr class="req-group-header"><td colspan="6"><strong>Req ID: ${reqId.split('-')[1]}</strong></td></tr>`;
                
                reqItems.forEach(item => {
                    const myBid = myBids.find(b => b.ItemID === item.ItemID);
                    const row = document.createElement('tr');
                    row.dataset.item = JSON.stringify(item);
                    row.innerHTML = `
                        <td><input type="checkbox" class="form-check-input vendor-item-checkbox"></td>
                        <td>${item.ItemName}</td>
                        <td>${item.Quantity} ${item.Unit}</td>
                        <td>${createImageLinks(item)}</td>
                        <td>${item.FreightRequired ? 'Yes' : 'No'}</td>
                        <td>${myBid ? `<span class="badge bg-success">Submitted</span>` : `<span class="badge bg-warning">Pending</span>`}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        async function loadVendorMyBidsView() { const tbody = document.getElementById('vendor-bids-tbody'); tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`; const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const [bids, allBids, items] = await Promise.all([getData('Bids', true), getData('Bids', true), getData('RequisitionItems')]); const myBids = (bids || []).filter(b => b.VendorID === currentUser.UserID); const bidsByItem = (allBids || []).reduce((acc, bid) => { (acc[bid.ItemID] = acc[bid.ItemID] || []).push(bid); return acc; }, {}); for(const itemID in bidsByItem) { bidsByItem[itemID].sort((a, b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount)); } tbody.innerHTML = ''; myBids.sort((a,b) => new Date(b.SubmittedAt) - new Date(a.SubmittedAt)).forEach(bid => { const item = items.find(i => i.ItemID === bid.ItemID) || {}; const rankList = bidsByItem[bid.ItemID] || []; const myRankIndex = rankList.findIndex(b => b.BidID === bid.BidID); const myRank = myRankIndex !== -1 ? `L${myRankIndex + 1}` : 'N/A'; tbody.innerHTML += `<tr><td>${item.RequisitionID?.split('-')[1] || ''}-${item.ItemSLNo || ''}</td><td>${item.ItemName || 'N/A'}</td><td>${formatCurrency(bid.BidAmount)}</td><td><span class="badge bg-info">${myRank}</span></td><td><span class="badge bg-${getBadgeColor(bid.BidStatus)}">${bid.BidStatus}</span></td><td>${new Date(bid.SubmittedAt).toLocaleDateString()}</td></tr>`; }); }
        async function loadVendorAwarded() { const tbody = document.getElementById('vendor-awarded-tbody'); tbody.innerHTML = `<tr><td colspan="4" class="text-center">Loading...</td></tr>`; const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const awarded = (await getData('AwardedContracts', true) || []).filter(c => c.VendorID === currentUser.UserID); tbody.innerHTML = ''; awarded.forEach(c => { tbody.innerHTML += `<tr><td>${c.ContractID.split('-')[1]}</td><td>${c.ItemName}</td><td>${formatCurrency(c.AwardedAmount)}</td><td>${new Date(c.AwardedDate).toLocaleDateString()}</td></tr>`; }); }

        // =================================================================
        // =========== 5. USER PANEL FUNCTIONS =============================
        // =================================================================
        async function loadUserCreateReq() { document.getElementById('requisition-items-container').innerHTML = ''; itemCounter = 0; addRequisitionItem(); const checklistDiv = document.getElementById('req-vendor-checklist'); checklistDiv.innerHTML = '<p class="text-muted">Loading...</p>'; const vendors = (await getData('Users', true) || []).filter(u => u.Role === 'Vendor'); if (vendors.length > 0) { checklistDiv.innerHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input vendor-checkbox-user" type="checkbox" value="${v.UserID}" id="v-${v.UserID}"><label class="form-check-label" for="v-${v.UserID}">${v.FullName}</label></div>`).join(''); document.getElementById('select-all-vendors-user').onchange = (e) => { document.querySelectorAll('.vendor-checkbox-user').forEach(cb => cb.checked = e.target.checked); }; } else { checklistDiv.innerHTML = '<p class="text-danger">No vendors found.</p>'; } }
        
        let itemCounter = 0;
        function addRequisitionItem() {
            itemCounter++;
            const itemCard = document.createElement('div');
            itemCard.className = 'card card-body mb-3';
            itemCard.id = `item-card-${itemCounter}`;

            const productOptions = PRODUCT_LIST.map(p =>
                `<option value='${JSON.stringify(p)}'>${p.ITEM_NAME}</option>`
            ).join('');
            
            const locationOptions = LOCATION_DROPDOWN_DATA.map(loc => `<option value="${loc}">${loc}</option>`).join('');

            itemCard.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="text-primary mb-0">Item #${itemCounter}</h6>
                    ${itemCounter > 1 ? `<button type="button" class="btn-close" onclick="this.closest('.card').remove()"></button>` : ''}
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4 mb-3">
                         <label class="form-label">Item Code</label>
                         <input type="text" class="form-control req-item-code" oninput="syncItemFields(this)" placeholder="Type Code...">
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Item Name (Product Name)</label>
                        <select class="form-select req-item-name" id="item-name-${itemCounter}" required onchange="syncItemFields(this)">
                            <option value="">Select or Search an Item...</option>
                            ${productOptions}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" step="any" class="form-control req-quantity" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Unit</label>
                        <input type="text" class="form-control req-unit" placeholder="Auto-fetches from item" required readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Freight Required?</label>
                        <select class="form-select req-freight-required" required>
                            <option value="">Select...</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="form-label">Delivery Location</label>
                        <select class="form-select req-delivery-location" required>
                            <option value="">Select Delivery Location...</option>
                            ${locationOptions}
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control req-description" rows="2"></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Drawing (Optional)</label>
                        <input type="file" class="form-control req-drawing-image" accept="image/*,.pdf,.dwg">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Specimen (Optional)</label>
                        <input type="file" class="form-control req-specimen-image" accept="image/*">
                    </div>
                </div>
            `;
            document.getElementById('requisition-items-container').appendChild(itemCard);
            
            $('#item-name-' + itemCounter).select2({
                theme: "bootstrap-5",
                placeholder: 'Select or Search an Item...'
            });
        }
        
        function syncItemFields(changedElement) {
            const itemCard = changedElement.closest('.card-body');
            if (!itemCard) {
                console.error("Could not find parent card for element:", changedElement);
                return;
            }

            const codeInput = itemCard.querySelector('.req-item-code');
            const nameSelect = itemCard.querySelector('.req-item-name');
            const unitInput = itemCard.querySelector('.req-unit');

            if (!codeInput || !nameSelect || !unitInput) {
                console.error("Could not find one or more required fields in the item card.");
                return;
            }

            if (changedElement.classList.contains('req-item-name')) {
                const selectedOptionValue = $(nameSelect).val();
                if (!selectedOptionValue) {
                    codeInput.value = '';
                    unitInput.value = '';
                    return;
                }
                try {
                    const product = JSON.parse(selectedOptionValue);
                    codeInput.value = product.ITEM_CODE || '';
                    // Robustly check for UM, um, or Unit property
                    unitInput.value = product.UM || product.um || product.Unit || '';
                } catch (e) {
                    console.error("Could not parse product JSON from option value:", selectedOptionValue, e);
                    codeInput.value = '';
                    unitInput.value = '';
                }

            } else if (changedElement.classList.contains('req-item-code')) {
                const enteredCode = codeInput.value.trim().toUpperCase();
                if (!enteredCode) {
                    $(nameSelect).val(null).trigger('change');
                    return;
                }

                let foundOptionValue = null;
                for (const option of nameSelect.options) {
                    if (option.value) {
                        try {
                            const product = JSON.parse(option.value);
                            if (product.ITEM_CODE && product.ITEM_CODE.toUpperCase() === enteredCode) {
                                foundOptionValue = option.value;
                                break;
                            }
                        } catch (e) {
                            continue; // Ignore options with invalid JSON
                        }
                    }
                }
                $(nameSelect).val(foundOptionValue).trigger('change');
            }
        }
        
        async function loadUserStatusView() { const listDiv = document.getElementById('user-req-status-list'); listDiv.innerHTML = `<div class="text-center p-4">Loading...</div>`; const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const [reqs, items, awarded] = await Promise.all([getData('Requisitions', true), getData('RequisitionItems'), getData('AwardedContracts')]); const myReqs = (reqs || []).filter(r => r.CreatedBy === currentUser.UserID).sort((a,b) => new Date(b.CreatedAt) - new Date(a.CreatedAt)); listDiv.innerHTML = myReqs.length > 0 ? '' : '<div class="alert alert-info">No requisitions created yet.</div>'; myReqs.forEach(req => { const reqItems = (items || []).filter(i => i.RequisitionID === req.RequisitionID); const itemsHTML = reqItems.map(item => { let awardedInfo = ''; if (item.Status === 'Awarded') { const contract = (awarded || []).find(c => c.ItemID === item.ItemID); if(contract) awardedInfo = `<small class="d-block text-success">Awarded to: ${contract.VendorName} for ${formatCurrency(contract.AwardedAmount)}</small>`; } return `<li class="list-group-item"><div class="d-flex w-100 justify-content-between"><small><strong>${item.ItemSLNo}.</strong> ${item.ItemName}</small><span class="badge bg-${getBadgeColor(item.Status)}">${item.Status}</span></div>${awardedInfo}</li>`; }).join(''); listDiv.innerHTML += `<div class="card mb-3"><div class="card-header d-flex justify-content-between"><strong>Req ID: ${req.RequisitionID.split('-')[1]}</strong><span class="badge bg-${getBadgeColor(req.Status)}">${req.Status}</span></div><ul class="list-group list-group-flush">${itemsHTML}</ul></div>`; }); }
        
        // =================================================================
        // =========== 6. ACTION HANDLERS & MODAL LOGIC ====================
        // =================================================================
        
        async function handleRequisitionSubmit(e) {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Submitting...`;
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                const selectedVendorIds = Array.from(document.querySelectorAll('#req-vendor-checklist input:checked')).map(input => input.value);
                const itemCards = document.querySelectorAll('#requisition-items-container .card');
                if (itemCards.length === 0) { throw new Error("Please add at least one item."); }
                
                showToast("Uploading images, please wait...", "info");
                const imageUploadPromises = [];
                itemCards.forEach(card => {
                    imageUploadPromises.push(uploadImage(card.querySelector('.req-drawing-image').files[0]));
                    imageUploadPromises.push(uploadImage(card.querySelector('.req-specimen-image').files[0]));
                });
                const uploadedImageUrls = await Promise.all(imageUploadPromises);
                
                const itemsPayload = [];
                for (const [index, card] of Array.from(itemCards).entries()) {
                    const nameSelect = card.querySelector('.req-item-name');
                    if (!nameSelect.value) throw new Error("Please select an item for all line items.");
                    
                    itemsPayload.push({
                        ItemCode: card.querySelector('.req-item-code').value,
                        ItemName: $(nameSelect).find('option:selected').text(),
                        FreightRequired: card.querySelector('.req-freight-required').value === 'true',
                        Quantity: card.querySelector('.req-quantity').value,
                        Unit: card.querySelector('.req-unit').value,
                        Description: card.querySelector('.req-description').value,
                        DeliveryLocation: card.querySelector('.req-delivery-location').value,
                        DrawingURL: uploadedImageUrls[index * 2],
                        SpecimenURL: uploadedImageUrls[index * 2 + 1]
                    });
                }
                const result = await postData({ action: 'createRequisition', data: { CreatedBy: currentUser.UserID, vendorIds: selectedVendorIds, items: itemsPayload } });
                if (result.success) { showToast(result.message, 'success'); e.target.reset(); loadUserCreateReq(); navigateTo('user-status-view'); }
            } catch (error) {
                console.error('Requisition Submission Error:', error);
                showToast(error.message || 'Submission failed.', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `Submit Requisition for Approval`;
            }
        }
        async function handleBulkApproval(reqId) { const container = document.getElementById(`collapse-${reqId}`); const approvedItemIds = Array.from(container.querySelectorAll('.item-check-box:checked')).map(cb => cb.value); const vendorAssignments = Array.from(container.querySelectorAll('.vendor-assign-check:checked')).map(cb => cb.value); if (approvedItemIds.length === 0) { showToast('Please select at least one item to approve.', 'warning'); return; } const result = await postData({ action: 'approveRequisitionItems', data: { requisitionID: reqId, approvedItemIds, vendorAssignments } }); if (result.success) { showToast(result.message, 'success'); handleManualRefresh(); } }
        async function approveUser(tempId, userEmail, userName) { const result = await postData({ action: 'approveUser', data: { TempID: tempId } }); if (result.success) { showToast(result.message, 'success'); postData({ action: 'sendEmail', data: { recipient: userEmail, subject: "Account Approved", body: `Hello ${userName},\n\nYour account for DEB'S PROCUREMENT has been approved. You can now log in.` } }); handleManualRefresh(); } }
        async function openAdminActionModalByItemId(itemId) { const item = (APP_DATA.RequisitionItems || []).find(i => i.ItemID === itemId); if (item) openAdminActionModal(item); }
        async function openAdminActionModal(item) {
            document.getElementById('adminActionModalTitle').textContent = `Bids for: ${item.ItemName}`;
            document.getElementById('admin-action-remarks').value = '';
            document.getElementById('req-image-preview').innerHTML = `<img src="${item.DrawingURL}" style="max-height: 150px; margin-right: 15px;" onerror="this.style.display='none'"><img src="${item.SpecimenURL}" style="max-height: 150px;" onerror="this.style.display='none'">`;
            document.getElementById('reopen-bidding-btn').onclick = () => { handleSingleReopenBidding(item.ItemID); adminActionModal.hide(); };
            const bidsTbody = document.getElementById('bids-tbody');
            bidsTbody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`;
            adminActionModal.show();
            const [bids, users] = await Promise.all([getData('Bids'), getData('Users')]);
            const relevantBids = (bids || []).filter(b => b.ItemID === item.ItemID).sort((a,b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount));
            bidsTbody.innerHTML = '';
            relevantBids.forEach((bid, index) => {
                const vendor = users.find(u => u.UserID === bid.VendorID);
                bid.VendorEmail = vendor?.Email || null;
                bid.ItemName = item.ItemName;
                bid.VendorName = vendor?.FullName || 'N/A';
                bid.RequisitionID = item.RequisitionID;
                bidsTbody.innerHTML += `<tr data-bid='${JSON.stringify(bid)}'><td><input type="checkbox" class="form-check-input bid-checkbox" ${bid.BidStatus === 'Awarded' || bid.BidStatus === 'Rejected' ? 'disabled' : ''}></td><td><span class="badge bg-info">L${index + 1}</span></td><td>${vendor?.FullName || 'N/A'}</td><td>${formatCurrency(bid.ExWorksRate)}</td><td>${formatCurrency(bid.FreightRate)}</td><td><strong>${formatCurrency(bid.BidAmount)}</strong></td><td><span class="badge bg-${getBadgeColor(bid.BidStatus)}">${bid.BidStatus}</span></td></tr>`;
            });
        }
        
        function selectAllL1Bids() { const bidsTbody = document.getElementById('bids-tbody'); const rows = bidsTbody.querySelectorAll('tr'); if (rows.length === 0) return; let minAmount = Infinity; rows.forEach(row => { const checkbox = row.querySelector('.bid-checkbox:not(:disabled)'); if (checkbox) { try { const bidData = JSON.parse(row.dataset.bid || '{}'); const amount = parseFloat(bidData.BidAmount); if (!isNaN(amount) && amount < minAmount) { minAmount = amount; } } catch(e) { console.error("Could not parse bid data from row:", row); } } }); if (minAmount === Infinity) { showToast('No selectable L1 bids found.', 'info'); return; } let bidsSelected = 0; rows.forEach(row => { const checkbox = row.querySelector('.bid-checkbox:not(:disabled)'); if (checkbox) { try { const bidData = JSON.parse(row.dataset.bid || '{}'); const amount = parseFloat(bidData.BidAmount); if (Math.abs(amount - minAmount) < 0.01) { checkbox.checked = true; bidsSelected++; } } catch(e) { console.error("Could not parse bid data for selection:", row); } } }); if(bidsSelected > 0) { showToast(`Selected ${bidsSelected} L1 bid(s).`, 'success'); } }
        async function handleBulkAwardSubmit() { const remarks = document.getElementById('admin-action-remarks').value.trim(); const selectedRows = Array.from(document.querySelectorAll('#bids-tbody tr')).filter(row => row.querySelector('.bid-checkbox:checked')); if (selectedRows.length === 0) { showToast('Please select at least one bid to award.', 'warning'); return; } if (!remarks) { showToast('Remarks are mandatory to award or re-award a bid.', 'error'); return; } const winningBids = selectedRows.map(row => { const bid = JSON.parse(row.dataset.bid); bid.Remarks = remarks; return bid; }); const result = await postData({ action: 'awardBulkContracts', data: { bids: winningBids } }); if (result.success) { showToast(result.message, 'success'); sendConsolidatedAwardEmails(winningBids); adminActionModal.hide(); handleManualRefresh(); } }
        
        async function openReopenBiddingModal(itemIds) {
            document.getElementById('reopen-item-ids').value = JSON.stringify(itemIds);
            document.getElementById('reopen-remarks').value = '';
            const checklistDiv = document.getElementById('reopen-vendor-checklist');
            checklistDiv.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
            reopenBiddingModal.show();
            const allUsers = await getData('Users');
            const vendors = (allUsers || []).filter(u => u.Role === 'Vendor');
            if (vendors.length > 0) {
                checklistDiv.innerHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input reopen-vendor-checkbox" type="checkbox" value="${v.UserID}" id="reopen-v-${v.UserID}" checked><label class="form-check-label" for="reopen-v-${v.UserID}">${v.FullName}</label></div>`).join('');
            } else { checklistDiv.innerHTML = '<p class="text-danger">No vendors found.</p>'; }
        }

        function handleSingleReopenBidding(itemId) {
            openReopenBiddingModal([itemId]);
        }

        function handleBulkReopenModal() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('#admin-awarded-tbody .awarded-item-checkbox:checked'));
            if (selectedCheckboxes.length === 0) {
                showToast('Please select at least one awarded item to re-open.', 'warning');
                return;
            }
            const itemIdsToReopen = selectedCheckboxes.map(cb => cb.dataset.itemId);
            openReopenBiddingModal(itemIdsToReopen);
        }

        async function submitReopenBidding() {
            const itemIds = JSON.parse(document.getElementById('reopen-item-ids').value);
            const remarks = document.getElementById('reopen-remarks').value.trim();
            const selectedVendorIds = Array.from(document.querySelectorAll('#reopen-vendor-checklist input:checked')).map(input => input.value);

            if (!remarks) { showToast('Remarks are mandatory to re-open bidding.', 'error'); return; }
            if (selectedVendorIds.length === 0) { showToast('Please select at least one vendor.', 'warning'); return; }
            if (!confirm(`Are you sure you want to re-open bidding for ${itemIds.length} item(s) with ${selectedVendorIds.length} vendor(s)?`)) return;

            const payload = {
                action: 'reopenBiddingWithVendors',
                data: {
                    ItemIDs: itemIds,
                    Remarks: remarks,
                    VendorIDs: selectedVendorIds
                }
            };
            
            const result = await postData(payload);
            
            if (result.success) {
                showToast(result.message, 'success');
                reopenBiddingModal.hide();
                handleManualRefresh();
            }
        }
        
        async function handleAdvancedBulkAward() { const selectedRows = Array.from(document.querySelectorAll('#admin-req-tbody tr')).filter(row => row.querySelector('.req-item-checkbox:checked')); if (selectedRows.length === 0) { showToast('Please select at least one item to award.', 'warning'); return; } const itemIds = selectedRows.map(row => row.dataset.itemId); showLoader(); const [allItems, allBids, allUsers] = await Promise.all([ getData('RequisitionItems', true), getData('Bids', true), getData('Users', true) ]); const accordionContainer = document.getElementById('advanced-bulk-award-modal-body'); accordionContainer.innerHTML = ''; itemIds.forEach((itemId, index) => { const item = allItems.find(i => i.ItemID === itemId); const bidsForItem = (allBids || []).filter(b => b.ItemID === itemId).sort((a, b) => parseFloat(a.BidAmount) - parseFloat(b.BidAmount)); let bidsTableHtml = '<p class="text-center text-muted">No bids submitted.</p>'; if (bidsForItem.length > 0) { bidsTableHtml = `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Select</th><th>Rank</th><th>Vendor</th><th>Amount (₹)</th></tr></thead><tbody>${bidsForItem.map((bid, rankIndex) => { const vendor = allUsers.find(u => u.UserID === bid.VendorID); const bidData = { BidID: bid.BidID, ItemID: bid.ItemID, VendorID: bid.VendorID, BidAmount: bid.BidAmount, ExWorksRate: bid.ExWorksRate, FreightRate: bid.FreightRate, ItemName: item.ItemName, VendorName: vendor.FullName, VendorEmail: vendor.Email, RequisitionID: item.RequisitionID, ItemSLNo: item.ItemSLNo }; return `<tr><td><input class="form-check-input" type="radio" name="award-radio-${itemId}" value='${JSON.stringify(bidData)}'></td><td><span class="badge bg-info">L${rankIndex + 1}</span></td><td>${vendor?.FullName || 'N/A'}</td><td><strong>${formatCurrency(bid.BidAmount)}</strong></td></tr>`; }).join('')}</tbody></table></div>`; } accordionContainer.innerHTML += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-award-${itemId}"><strong>Item:</strong> ${item.ItemName} (ID: ${item.RequisitionID.split('-')[1]}-${item.ItemSLNo})</button></h2><div id="collapse-award-${itemId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#advanced-bulk-award-modal-body"><div class="accordion-body">${bidsTableHtml}</div></div></div>`; }); hideLoader(); document.getElementById('advanced-bulk-award-remarks').value = ''; advancedBulkAwardModal.show(); }
        async function handleSubmitAdvancedBulkAward() { const remarks = document.getElementById('advanced-bulk-award-remarks').value.trim(); if (!remarks) { showToast('Remarks are mandatory.', 'error'); return; } const selectedRadioButtons = document.querySelectorAll('#advanced-bulk-award-modal-body input[type="radio"]:checked'); if (selectedRadioButtons.length === 0) { showToast('Please select at least one bid to award.', 'warning'); return; } const winningBids = Array.from(selectedRadioButtons).map(radio => { const bidData = JSON.parse(radio.value); bidData.Remarks = remarks; return bidData; }); if (!confirm(`Award contracts for ${winningBids.length} selected bid(s)?`)) return; const result = await postData({ action: 'awardBulkContracts', data: { bids: winningBids } }); if (result.success) { showToast(result.message, 'success'); sendConsolidatedAwardEmails(winningBids); advancedBulkAwardModal.hide(); handleManualRefresh(); } }
        
        function openCrossRequisitionBidModal() {
            const selectedRows = Array.from(document.querySelectorAll('#vendor-reqs-tbody tr')).filter(row => row.querySelector('.vendor-item-checkbox:checked'));
            if(selectedRows.length === 0) {
                showToast('Please select at least one item to bid on.', 'warning');
                return;
            }
            const itemsToBidOn = selectedRows.map(row => JSON.parse(row.dataset.item));
            openBulkBidModal(itemsToBidOn, true);
        }
        
        function openBulkBidModal(items, isCrossReq = false) {
            const title = isCrossReq ? `${items.length} Selected Items` : `Bidding for Req: ${items[0].RequisitionID.split('-')[1]}`;
            document.getElementById('bulkBidModalTitle').textContent = title;
            const container = document.getElementById('bulk-bid-items-container'); 
            container.innerHTML = `<table class="table table-bordered"><thead><tr><th>Item Name</th><th>Ex-works/Unit</th><th>Freight/Unit</th><th>Comments</th></tr></thead><tbody id="bulk-bid-tbody"></tbody></table>`; 
            const tbody = document.getElementById('bulk-bid-tbody'); 
            items.forEach(item => { tbody.innerHTML += `<tr data-item='${JSON.stringify(item)}'><td>${item.ItemName} (${item.Quantity} ${item.Unit})</td><td><input type="number" step="0.01" class="form-control form-control-sm ex-works-rate" required></td><td><input type="number" step="0.01" class="form-control form-control-sm freight-rate" ${item.FreightRequired ? 'required' : ''} ${!item.FreightRequired ? 'value="0" disabled' : ''}></td><td><input type="text" class="form-control form-control-sm comments"></td></tr>`; }); 
            bulkBidModal.show(); 
        }

        async function handleBulkBidSubmit(e) { e.preventDefault(); const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const bidRows = document.querySelectorAll('#bulk-bid-tbody tr'); const bidsPayload = Array.from(bidRows).map(row => { const item = JSON.parse(row.dataset.item); const exWorks = parseFloat(row.querySelector('.ex-works-rate').value); const freight = parseFloat(row.querySelector('.freight-rate').value) || 0; const totalAmount = (item.Quantity * exWorks) + (item.Quantity * freight); return { ItemID: item.ItemID, ExWorksRate: exWorks, FreightRate: freight, BidAmount: totalAmount.toFixed(2), Comments: row.querySelector('.comments').value }; }); const result = await postData({ action: 'createBulkBid', data: { VendorID: currentUser.UserID, bids: bidsPayload } }); if (result.success) { showToast(result.message, 'success'); bulkBidModal.hide(); handleManualRefresh(); } }
        function openEditUserModal(user) { document.getElementById('edit-userid').value = user.UserID; document.getElementById('edit-fullname').value = user.FullName; document.getElementById('edit-email').value = user.Email; document.getElementById('edit-role').value = user.Role; document.getElementById('edit-company').value = user.CompanyName || ''; document.getElementById('edit-contact').value = user.ContactNumber || ''; document.getElementById('edit-gstin').value = user.GSTIN || ''; document.getElementById('edit-password').value = ''; editUserModal.show(); }
        async function handleUserUpdateSubmit(e) { e.preventDefault(); const record = { FullName: document.getElementById('edit-fullname').value, Email: document.getElementById('edit-email').value, Role: document.getElementById('edit-role').value, CompanyName: document.getElementById('edit-company').value, ContactNumber: document.getElementById('edit-contact').value, GSTIN: document.getElementById('edit-gstin').value }; const newPassword = document.getElementById('edit-password').value; if (newPassword) record.Password = newPassword; const result = await postData({ action: 'updateUser', data: { UserID: document.getElementById('edit-userid').value, record: record } }); if (result.success) { showToast('User updated!', 'success'); editUserModal.hide(); handleManualRefresh(); } }
        async function openAssignVendorsModal(itemId) { const item = (APP_DATA.RequisitionItems || []).find(i => i.ItemID === itemId); if (!item) return; document.getElementById('assignVendorModalTitle').textContent = `Assign Vendors for: ${item.ItemName}`; document.getElementById('assign-vendor-item-id').value = item.ItemID; const checklistDiv = document.getElementById('assign-vendor-checklist'); checklistDiv.innerHTML = 'Loading...'; assignVendorsModal.show(); const [allVendors, assignments] = await Promise.all([getData('Users'), getData('RequisitionAssignments')]); const vendors = allVendors.filter(u => u.Role === 'Vendor'); const currentAssignments = (assignments || []).filter(a => a.RequisitionID === item.RequisitionID).map(a => a.VendorID); checklistDiv.innerHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input assign-vendor-checkbox" type="checkbox" value="${v.UserID}" id="assign-v-${v.UserID}" ${currentAssignments.includes(v.UserID) ? 'checked' : ''}><label class="form-check-label" for="assign-v-${v.UserID}">${v.FullName}</label></div>`).join(''); }
        async function handleUpdateVendorAssignments() { const itemId = document.getElementById('assign-vendor-item-id').value; const item = (APP_DATA.RequisitionItems || []).find(i => i.ItemID === itemId); const selectedVendorIds = Array.from(document.querySelectorAll('#assign-vendor-checklist input:checked')).map(input => input.value); const result = await postData({ action: 'updateVendorAssignments', data: { RequisitionID: item.RequisitionID, VendorIDs: selectedVendorIds } }); if (result.success) { showToast('Vendor assignments updated!', 'success'); assignVendorsModal.hide(); } }
        
        // =================================================================
        // =========== 7. MESSAGING FUNCTIONS ==============================
        // =================================================================
        async function loadMessages() { const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const chatList = document.getElementById('chat-list'); chatList.innerHTML = '<div class="list-group-item text-center">Loading conversations...</div>'; const allUsers = await getData('Users'); let conversations = []; if (currentUser.Role === 'Admin') { conversations = (allUsers || []).filter(u => u.UserID !== currentUser.UserID); } else if (currentUser.Role === 'User') { conversations = (allUsers || []).filter(u => u.Role === 'Vendor' || u.Role === 'Admin'); } else if (currentUser.Role === 'Vendor') { conversations = (allUsers || []).filter(u => u.Role === 'Admin' || u.Role === 'User');} chatList.innerHTML = ''; if (conversations.length > 0) { conversations.forEach(user => { const chatItem = document.createElement('a'); chatItem.className = 'list-group-item list-group-item-action'; chatItem.href = '#'; chatItem.dataset.userid = user.UserID; chatItem.dataset.username = user.FullName; chatItem.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${user.FullName}</h6></div><small class="text-muted">${user.Role}</small>`; chatItem.onclick = (e) => { e.preventDefault(); document.querySelectorAll('#chat-list .list-group-item').forEach(li => li.classList.remove('active')); chatItem.classList.add('active'); openChat(user.UserID, user.FullName); }; chatList.appendChild(chatItem); }); } else { chatList.innerHTML = '<div class="list-group-item text-muted">No conversations started.</div>'; } }
        
        async function openChat(recipientId, recipientName) {
            if (chatPollingInterval) clearInterval(chatPollingInterval);
            document.getElementById('chat-welcome').classList.add('d-none');
            document.getElementById('chat-window').classList.remove('d-none');
            document.getElementById('chat-with-name').textContent = recipientName;
            document.getElementById('message-form').onsubmit = (e) => { e.preventDefault(); handleSendMessage(recipientId); };
            const fetchAndRenderMessages = async () => {
                const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                const allMessages = await getDataSilent('Messages') || [];
                const conversationMessages = allMessages.filter(msg => (msg.SenderID === currentUser.UserID && msg.RecipientID === recipientId) || (msg.SenderID === recipientId && msg.RecipientID === currentUser.UserID)).sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));
                const messagesDiv = document.getElementById('chat-messages');
                const shouldScroll = messagesDiv.scrollTop + messagesDiv.clientHeight >= messagesDiv.scrollHeight - 20;
                messagesDiv.innerHTML = '';
                conversationMessages.forEach(msg => {
                    const isSent = msg.SenderID === currentUser.UserID;
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    bubble.innerHTML = `${msg.MessageBody.replace(/\n/g, '<br>')}<small>${new Date(msg.Timestamp).toLocaleString()}</small>`;
                    messagesDiv.appendChild(bubble);
                });
                if(shouldScroll) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            };
            await fetchAndRenderMessages();
            chatPollingInterval = setInterval(fetchAndRenderMessages, 10000);
        }
        
        async function handleSendMessage(recipientId) { const messageInput = document.getElementById('message-input'); const messageBody = messageInput.value.trim(); if (!messageBody) return; const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const payload = { SenderID: currentUser.UserID, RecipientID: recipientId, MessageBody: messageBody }; messageInput.disabled = true; const result = await postData({ action: 'sendMessage', data: payload }); messageInput.disabled = false; if (result.success) { messageInput.value = ''; const messagesDiv = document.getElementById('chat-messages'); const bubble = document.createElement('div'); bubble.className = 'message-bubble sent'; bubble.innerHTML = `${payload.MessageBody.replace(/\n/g, '<br>')}<small>${new Date().toLocaleString()}</small>`; messagesDiv.appendChild(bubble); messagesDiv.scrollTop = messagesDiv.scrollHeight; } }

        // =================================================================
        // =========== 8. REPORTING & HELPER FUNCTIONS =====================
        // =================================================================
        function updateReportView() { const awardedData = APP_DATA.AwardedContracts || []; const allItems = APP_DATA.RequisitionItems || []; const allBids = APP_DATA.Bids || []; const allUsers = APP_DATA.Users || []; const startDate = document.getElementById('report-start-date').value; const endDate = document.getElementById('report-end-date').value; const filteredAwarded = awardedData.filter(c => { const awardDate = new Date(c.AwardedDate); return (!startDate || awardDate >= new Date(startDate)) && (!endDate || awardDate <= new Date(new Date(endDate).getTime() + 86400000)); }); const totalSpend = filteredAwarded.reduce((sum, item) => sum + parseFloat(item.AwardedAmount || 0), 0); document.getElementById('report-total-spend').textContent = formatCurrency(totalSpend); let costSavings = 0; filteredAwarded.forEach(award => { const bidsForItem = allBids.filter(b => b.ItemID === award.ItemID).sort((a,b) => a.BidAmount - b.BidAmount); if (bidsForItem.length > 1) { costSavings += (bidsForItem[1].BidAmount - bidsForItem[0].BidAmount); } }); document.getElementById('report-cost-savings').textContent = formatCurrency(costSavings); const itemsWithBids = allItems.filter(i => allBids.some(b => b.ItemID === i.ItemID)); const avgBids = itemsWithBids.length > 0 ? (allBids.length / itemsWithBids.length) : 0; document.getElementById('report-avg-bids').textContent = avgBids.toFixed(1); const awardedItemsWithDates = filteredAwarded.map(award => { const item = allItems.find(i => i.ItemID === award.ItemID); return item ? { createdAt: new Date(item.CreatedAt), awardedAt: new Date(award.AwardedDate) } : null; }).filter(Boolean); if (awardedItemsWithDates.length > 0) { const totalDays = awardedItemsWithDates.reduce((sum, d) => sum + (d.awardedAt - d.createdAt), 0); const avgDays = (totalDays / awardedItemsWithDates.length) / (1000 * 60 * 60 * 24); document.getElementById('report-cycle-time').textContent = `${avgDays.toFixed(0)} Days`; } else { document.getElementById('report-cycle-time').textContent = '0 Days'; } const spendByVendor = filteredAwarded.reduce((acc, item) => { acc[item.VendorName] = (acc[item.VendorName] || 0) + parseFloat(item.AwardedAmount || 0); return acc; }, {}); if(vendorSpendChart) vendorSpendChart.destroy(); vendorSpendChart = new Chart(document.getElementById('vendorSpendChart'), { type: 'bar', data: { labels: Object.keys(spendByVendor), datasets: [{ label: 'Total Spend (₹)', data: Object.values(spendByVendor), backgroundColor: '#0d6efd' }] }, options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false } }); const statusCounts = allItems.reduce((acc, item) => { acc[item.Status] = (acc[item.Status] || 0) + 1; return acc; }, {}); if(itemStatusChart) itemStatusChart.destroy(); itemStatusChart = new Chart(document.getElementById('itemStatusChart'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#198754', '#ffc107', '#0d6efd', '#6c757d', '#dc3545', '#0dcaf0'], }] }, options: { responsive: true, maintainAspectRatio: true } }); const spendByProduct = filteredAwarded.reduce((acc, item) => { acc[item.ItemName] = (acc[item.ItemName] || 0) + parseFloat(item.AwardedAmount || 0); return acc; }, {}); if(productSpendChart) productSpendChart.destroy(); productSpendChart = new Chart(document.getElementById('productSpendChart'), { type: 'bar', data: { labels: Object.keys(spendByProduct), datasets: [{ label: 'Total Spend (₹)', data: Object.values(spendByProduct), backgroundColor: '#198754' }] }, options: { indexAxis: 'y', scales: { x: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false } }); const vendorStats = allUsers.filter(u => u.Role === 'Vendor').map(vendor => { const bidsSubmitted = allBids.filter(b => b.VendorID === vendor.UserID).length; const contractsWon = filteredAwarded.filter(c => c.VendorID === vendor.UserID); const winRate = bidsSubmitted > 0 ? (contractsWon.length / bidsSubmitted) * 100 : 0; const totalValue = contractsWon.reduce((sum, c) => sum + parseFloat(c.AwardedAmount), 0); return { name: vendor.FullName, bidsSubmitted, contractsWon: contractsWon.length, winRate: winRate.toFixed(1), totalValue }; }).sort((a,b) => b.contractsWon - a.contractsWon); const tableBody = document.querySelector('#vendor-performance-table tbody'); tableBody.innerHTML = vendorStats.map(v => `<tr><td>${v.name}</td><td>${v.bidsSubmitted}</td><td>${v.contractsWon}</td><td>${v.winRate}%</td><td>${formatCurrency(v.totalValue)}</td></tr>`).join(''); }
        
        // ==================================================
        // =========== UPDATED FUNCTION STARTS HERE =========
        // ==================================================
        async function sendConsolidatedAwardEmails(winningBids) {
            try {
                const notificationsByVendor = {};

                // Group all awarded items by vendor email
                winningBids.forEach(bid => {
                    if (bid.VendorEmail) {
                        const vendorKey = bid.VendorEmail;
                        if (!notificationsByVendor[vendorKey]) {
                            notificationsByVendor[vendorKey] = {
                                vendorName: bid.VendorName,
                                vendorEmail: bid.VendorEmail,
                                items: []
                            };
                        }
                        notificationsByVendor[vendorKey].items.push({
                            name: bid.ItemName,
                            amount: formatCurrency(bid.BidAmount),
                            reqId: bid.RequisitionID.split('-')[1] // Keep Req ID for item context
                        });
                    }
                });

                for (const vendorKey in notificationsByVendor) {
                    const notification = notificationsByVendor[vendorKey];
                    const subject = `Contract Award Notification from DEB'S PROCUREMENT`;
                    
                    const itemsHtml = notification.items.map(item => `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.reqId}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${item.name}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;"><strong>${item.amount}</strong></td>
                        </tr>`).join('');

                    const htmlBody = `
                        <div style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                            <div style="max-width: 600px; margin: auto; border: 1px solid #ddd; border-radius: 8px; padding: 20px;">
                                <h2 style="color: #0d6efd; text-align: center;">Contract Award Notification</h2>
                                <p>Dear ${notification.vendorName},</p>
                                <p>Congratulations! You have been awarded the following item(s):</p>
                                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                                    <thead style="background-color: #f2f2f2;">
                                        <tr>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Req. ID</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Item Name</th>
                                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Awarded Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>${itemsHtml}</tbody>
                                </table>
                                <p>We look forward to working with you. Please proceed with the necessary formalities.</p>
                                <p>Best regards,<br><strong>DEB'S PROCUREMENT Team</strong></p>
                            </div>
                        </div>`;
                    
                    const plainBody = `Dear ${notification.vendorName},\n\nCongratulations! You have been awarded the following item(s):\n\n${notification.items.map(i => `  • Req ID: ${i.reqId}, Item: ${i.name}, Amount: ${i.amount}`).join('\n')}\n\nBest regards,\nDEB'S PROCUREMENT Team`;

                    postData({ 
                        action: 'sendEmail', 
                        data: { 
                            recipient: notification.vendorEmail, 
                            subject: subject, 
                            body: plainBody,
                            htmlBody: htmlBody
                        } 
                    });
                }
            } catch (e) {
                console.error("Failed to send award emails:", e);
                showToast("Award was successful, but could not send notification emails.", "warning");
            }
        }
        // ================================================
        // =========== UPDATED FUNCTION ENDS HERE =========
        // ================================================

        async function downloadBiddingHistoryReport() { const bids = await getData('Bids', true); const items = await getData('RequisitionItems'); const users = await getData('Users'); const dataToExport = bids.map(bid => { const item = items.find(i => i.ItemID === bid.ItemID) || {}; const vendor = users.find(u => u.UserID === bid.VendorID) || {}; return { 'Req ID': `${item.RequisitionID}-${item.ItemSLNo}`, 'Item Name': item.ItemName, 'Vendor Name': vendor.FullName, 'Ex-works Rate': bid.ExWorksRate, 'Freight Rate': bid.FreightRate, 'Total Bid Amount': bid.BidAmount, 'Status': bid.BidStatus, 'Submitted At': new Date(bid.SubmittedAt).toLocaleString() }; }); exportToExcel(dataToExport, 'Bidding_History.xlsx'); }
        async function downloadAwardedContractsReport() { const awarded = await getData('AwardedContracts', true); const dataToExport = awarded.map(c => ({ 'Req ID': `${c.RequisitionID.split('-')[1]}`, 'Item Name': c.ItemName, 'Item Code': c.ItemCode, 'Quantity': c.Quantity, 'Unit': c.Unit, 'Vendor Name': c.VendorName, 'Awarded Amount': c.AwardedAmount, 'Awarded Date': new Date(c.AwardedDate).toLocaleDateString(), 'Remarks': c.Remarks })); exportToExcel(dataToExport, 'Awarded_Contracts.xlsx'); }
        async function downloadVendorBidsHistory() { const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const bids = (await getData('Bids', true) || []).filter(b => b.VendorID === currentUser.UserID); const items = await getData('RequisitionItems'); const dataToExport = bids.map(bid => { const item = items.find(i => i.ItemID === bid.ItemID) || {}; return { 'Req ID': `${item.RequisitionID}-${item.ItemSLNo}`, 'Item Name': item.ItemName, 'My Bid Amount': bid.BidAmount, 'Status': bid.BidStatus, 'Submitted At': new Date(bid.SubmittedAt).toLocaleString() }; }); exportToExcel(dataToExport, `${currentUser.FullName}_Bids_History.xlsx`); }
        async function handleBulkUpload(e) { e.preventDefault(); const file = document.getElementById('bulk-upload-file').files[0]; const selectedVendorIds = Array.from(document.querySelectorAll('#bulk-vendor-checklist input:checked')).map(input => input.value); if (!file) { showToast('Please select a file.', 'error'); return; } const reader = new FileReader(); reader.onload = async (event) => { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, {type: 'array'}); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const json = XLSX.utils.sheet_to_json(worksheet); const itemsPayload = json.map(row => ({ ItemName: row['ItemName'], FreightRequired: String(row['FreightRequired']).toLowerCase() === 'yes', Quantity: row['Quantity'], Unit: row['Unit'], Description: row['Description'] })); const result = await postData({ action: 'createRequisition', data: { CreatedBy: JSON.parse(sessionStorage.getItem('loggedInUser')).UserID, vendorIds: selectedVendorIds, items: itemsPayload } }); if (result.success) { showToast(result.message, 'success'); bulkUploadModal.hide(); handleManualRefresh(); } }; reader.readAsArrayBuffer(file); }
        async function loadVendorsForBulkUpload() { const checklistDiv = document.getElementById('bulk-vendor-checklist'); checklistDiv.innerHTML = '<p class="text-muted">Loading...</p>'; const vendors = (await getData('Users') || []).filter(u => u.Role === 'Vendor'); if (vendors.length > 0) { checklistDiv.innerHTML = vendors.map(v => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${v.UserID}" id="bulk-v-${v.UserID}"><label class="form-check-label" for="bulk-v-${v.UserID}">${v.FullName}</label></div>`).join(''); document.getElementById('select-all-vendors-bulk').onchange = (e) => { checklistDiv.querySelectorAll('input').forEach(cb => cb.checked = e.target.checked); }; } else { checklistDiv.innerHTML = '<p class="text-danger">No vendors found.</p>'; } }
        function downloadBulkTemplate() { const data = [{ ItemName: 'Example Product', Quantity: 100, Unit: 'Pcs', FreightRequired: 'Yes', Description: 'Detailed description here' }]; const worksheet = XLSX.utils.json_to_sheet(data); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'Template'); XLSX.writeFile(workbook, 'Requirement_Bulk_Upload_Template.xlsx'); }
        function exportToExcel(data, fileName) { const worksheet = XLSX.utils.json_to_sheet(data); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1'); XLSX.writeFile(workbook, fileName); }
        async function uploadImage(file) { if (!file) return ''; const reader = new FileReader(); reader.readAsDataURL(file); const base64File = await new Promise(resolve => { reader.onload = () => resolve(reader.result); }); const result = await postData({ action: 'uploadImage', data: { file: base64File, fileName: file.name, mimeType: file.type } }); return result?.fileUrl || ''; }
        function formatCurrency(value) { const num = parseFloat(value); return isNaN(num) ? '-' : `₹${num.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; }
        function getBadgeColor(status) { const colors = { 'Awarded': 'primary', 'Active': 'success', 'Pending Approval': 'warning', 'Superseded': 'secondary', 'Submitted': 'info', 'Rejected': 'danger', 'Processed': 'dark' }; return colors[status] || 'dark'; }
        function createImageLinks(item) { return [item.DrawingURL, item.SpecimenURL].filter(Boolean).map((url, i) => `<a href="${url}" target="_blank" onclick="event.stopPropagation()" title="${i === 0 ? 'Drawing' : 'Specimen'}"><i class="fas ${i === 0 ? 'fa-ruler-combined' : 'fa-image'}"></i></a>`).join(' ') || '-'; }
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast-notification ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 5000); }
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }
        function toggleAllInParent(source, targetClass) { const parent = source.closest('table') || source.closest('.modal-body') || source.closest('.accordion-body') || source.closest('.card-body'); if (!parent) return; parent.querySelectorAll(`input[type="checkbox"].${targetClass}`).forEach(cb => { if (!cb.disabled) { cb.checked = source.checked; } }); }
    </script>
</body>
</html>
